<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allianz-System Auto-Setup</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d); 
            color: #fff; 
            padding: 20px; 
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button { 
            background: linear-gradient(135deg, #4CAF50, #45a049); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 10px 5px; 
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover { 
            background: linear-gradient(135deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            background: rgba(0,0,0,0.3);
            border-left: 4px solid #4CAF50;
        }
        .step {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        .step.completed {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        .step.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        pre { 
            background: #000; 
            padding: 15px; 
            border-radius: 8px; 
            overflow-x: auto; 
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        h1 {
            text-align: center;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Allianz-System Auto-Setup</h1>
        <p style="text-align: center; color: #ccc; margin-bottom: 30px;">
            Dieses Tool richtet automatisch die komplette Firebase-Datenbank f√ºr das Allianz-System ein.
        </p>
        
        <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="progress-text" style="text-align: center; margin-bottom: 20px;">Bereit f√ºr Setup...</div>
        
        <div class="step" id="step-1">
            <h3>1. Firebase-Verbindung</h3>
            <div id="step-1-status">Wird gepr√ºft...</div>
        </div>
        
        <div class="step" id="step-2">
            <h3>2. Collections erstellen</h3>
            <div id="step-2-status">Wartet...</div>
        </div>
        
        <div class="step" id="step-3">
            <h3>3. Test-Daten erstellen</h3>
            <div id="step-3-status">Wartet...</div>
        </div>
        
        <div class="step" id="step-4">
            <h3>4. Verifikation</h3>
            <div id="step-4-status">Wartet...</div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="startAutoSetup()" id="start-btn">üéØ Auto-Setup starten</button>
            <button onclick="checkStatus()" id="check-btn">üîç Status pr√ºfen</button>
            <button onclick="clearLogs()" id="clear-btn">üóëÔ∏è Logs l√∂schen</button>
        </div>
        
        <div class="status" id="main-status">
            <strong>Status:</strong> Bereit f√ºr Setup. Klicke "Auto-Setup starten" um zu beginnen.
        </div>
        
        <div style="margin-top: 30px;">
            <h3>üìù Logs</h3>
            <pre id="logs"></pre>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        let logs = [];
        let db = null;
        let setupComplete = false;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logsElement = document.getElementById('logs');
            logsElement.textContent = logs.join('\n');
            logsElement.scrollTop = logsElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').textContent = '';
        }
        
        function updateProgress(step, percentage, status) {
            document.getElementById(`step-${step}-status`).innerHTML = status;
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${percentage}% - ${status}`;
            
            if (percentage === 100) {
                document.getElementById('progress-text').textContent = '‚úÖ Setup abgeschlossen!';
            }
        }
        
        function setStepStatus(step, completed, status) {
            const stepElement = document.getElementById(`step-${step}`);
            stepElement.className = completed ? 'step completed' : 'step error';
            document.getElementById(`step-${step}-status`).innerHTML = status;
        }
        
        async function initializeFirebase() {
            try {
                log('Initialisiere Firebase...');
                
                const firebaseConfig = {
                    apiKey: 'AIzaSyDr4-ap_EubUn0UdP7hkEpS2jkzLIVgvyc',
                    authDomain: 'spacenations-tools.firebaseapp.com',
                    projectId: 'spacenations-tools',
                    storageBucket: 'spacenations-tools.firebasestorage.app',
                    messagingSenderId: '651338201276',
                    appId: '1:651338201276:web:89e7d9c19dbd2611d3f8b9',
                    measurementId: 'G-SKWJWH2ERX'
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }

                db = firebase.firestore();
                
                // Teste Verbindung
                await db.collection('_test').doc('connection').set({
                    test: true,
                    timestamp: new Date()
                });
                
                await db.collection('_test').doc('connection').delete();
                
                log('‚úÖ Firebase erfolgreich initialisiert');
                setStepStatus(1, true, '<span class="success">‚úÖ Verbindung erfolgreich</span>');
                updateProgress(1, 25, 'Firebase verbunden');
                return true;
                
            } catch (error) {
                log(`‚ùå Firebase-Fehler: ${error.message}`, 'error');
                setStepStatus(1, false, `<span class="error">‚ùå Fehler: ${error.message}</span>`);
                return false;
            }
        }
        
        async function createCollections() {
            try {
                log('Erstelle Collections...');
                
                // 1. Alliances Collection
                const testAlliance = {
                    name: 'Setup Test Allianz',
                    tag: 'SETUP',
                    description: 'Test-Allianz f√ºr Setup',
                    founder: 'system',
                    members: ['system'],
                    status: 'approved',
                    admin: 'system',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const allianceRef = await db.collection('alliances').add(testAlliance);
                log(`‚úÖ Alliances Collection erstellt (ID: ${allianceRef.id})`);
                
                // 2. Alliance Permissions Collection
                const permissions = {
                    chat_read: { enabled: true, description: "Chat lesen" },
                    chat_write: { enabled: true, description: "Chat schreiben" },
                    spy_database: { enabled: false, description: "Spionage-Datenbank" },
                    member_approval: { enabled: false, description: "Mitglieder best√§tigen" },
                    permission_manage: { enabled: false, description: "Berechtigungen verwalten" }
                };
                
                await db.collection('alliancePermissions').doc(allianceRef.id).set(permissions);
                log('‚úÖ AlliancePermissions Collection erstellt');
                
                // 3. Alliance Chats Collection
                const testMessage = {
                    content: 'Willkommen! Das Allianz-System wurde erfolgreich eingerichtet.',
                    author: 'system',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    allianceId: allianceRef.id
                };
                
                await db.collection('allianceChats').doc(allianceRef.id).collection('messages').add(testMessage);
                log('‚úÖ AllianceChats Collection erstellt');
                
                // 4. Alliance Activities Collection
                const activity = {
                    allianceId: allianceRef.id,
                    type: 'system_setup',
                    member: 'system',
                    performedBy: 'system',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    details: { message: 'Allianz-System Setup abgeschlossen' }
                };
                
                await db.collection('allianceActivities').add(activity);
                log('‚úÖ AllianceActivities Collection erstellt');
                
                // L√∂sche Test-Dokumente
                log('L√∂sche Test-Dokumente...');
                await allianceRef.delete();
                await db.collection('alliancePermissions').doc(allianceRef.id).delete();
                
                const messagesSnapshot = await db.collection('allianceChats').doc(allianceRef.id).collection('messages').get();
                messagesSnapshot.forEach(doc => doc.ref.delete());
                await db.collection('allianceChats').doc(allianceRef.id).delete();
                
                const activitiesSnapshot = await db.collection('allianceActivities')
                    .where('allianceId', '==', allianceRef.id)
                    .get();
                activitiesSnapshot.forEach(doc => doc.ref.delete());
                
                log('‚úÖ Test-Dokumente gel√∂scht');
                setStepStatus(2, true, '<span class="success">‚úÖ Alle Collections erstellt</span>');
                updateProgress(2, 50, 'Collections erstellt');
                return true;
                
            } catch (error) {
                log(`‚ùå Collection-Fehler: ${error.message}`, 'error');
                setStepStatus(2, false, `<span class="error">‚ùå Fehler: ${error.message}</span>`);
                return false;
            }
        }
        
        async function createTestData() {
            try {
                log('Erstelle Test-Daten...');
                
                const testAlliances = [
                    {
                        name: 'Space Warriors',
                        tag: 'SW',
                        description: 'Eine starke Allianz f√ºr erfahrene Spieler',
                        founder: 'testuser1',
                        members: ['testuser1'],
                        status: 'pending',
                        admin: null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    {
                        name: 'Galactic Empire',
                        tag: 'GE',
                        description: 'Herrschaft √ºber die Galaxie',
                        founder: 'testuser2',
                        members: ['testuser2'],
                        status: 'approved',
                        admin: 'testuser2',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }
                ];
                
                for (const alliance of testAlliances) {
                    const docRef = await db.collection('alliances').add(alliance);
                    log(`‚úÖ Test-Allianz erstellt: ${alliance.name} (ID: ${docRef.id})`);
                    
                    // Erstelle Berechtigungen
                    await db.collection('alliancePermissions').doc(docRef.id).set({
                        chat_read: { enabled: true, description: "Chat lesen" },
                        chat_write: { enabled: true, description: "Chat schreiben" },
                        spy_database: { enabled: false, description: "Spionage-Datenbank" },
                        member_approval: { enabled: false, description: "Mitglieder best√§tigen" },
                        permission_manage: { enabled: false, description: "Berechtigungen verwalten" }
                    });
                }
                
                setStepStatus(3, true, '<span class="success">‚úÖ Test-Daten erstellt</span>');
                updateProgress(3, 75, 'Test-Daten erstellt');
                return true;
                
            } catch (error) {
                log(`‚ùå Test-Daten Fehler: ${error.message}`, 'error');
                setStepStatus(3, false, `<span class="error">‚ùå Fehler: ${error.message}</span>`);
                return false;
            }
        }
        
        async function verifySetup() {
            try {
                log('Verifiziere Setup...');
                
                const collections = ['alliances', 'alliancePermissions', 'allianceChats', 'allianceActivities'];
                let allGood = true;
                
                for (const collectionName of collections) {
                    try {
                        const snapshot = await db.collection(collectionName).limit(1).get();
                        log(`‚úÖ ${collectionName}: ${snapshot.size} Dokumente`);
                    } catch (error) {
                        log(`‚ùå ${collectionName}: Fehler - ${error.message}`, 'error');
                        allGood = false;
                    }
                }
                
                if (allGood) {
                    setStepStatus(4, true, '<span class="success">‚úÖ Setup erfolgreich verifiziert</span>');
                    updateProgress(4, 100, 'Setup abgeschlossen');
                    setupComplete = true;
                    
                    document.getElementById('main-status').innerHTML = `
                        <span class="success">‚úÖ <strong>Setup erfolgreich abgeschlossen!</strong></span><br>
                        Das Allianz-System ist jetzt bereit f√ºr die Verwendung.<br>
                        <a href="user-dashboard.html" style="color: #4CAF50;">‚Üí Zum User-Dashboard</a> | 
                        <a href="admin-dashboard.html" style="color: #4CAF50;">‚Üí Zum Admin-Dashboard</a>
                    `;
                    
                    document.getElementById('start-btn').textContent = '‚úÖ Setup abgeschlossen';
                    document.getElementById('start-btn').disabled = true;
                    
                    return true;
                } else {
                    setStepStatus(4, false, '<span class="error">‚ùå Verifikation fehlgeschlagen</span>');
                    return false;
                }
                
            } catch (error) {
                log(`‚ùå Verifikations-Fehler: ${error.message}`, 'error');
                setStepStatus(4, false, `<span class="error">‚ùå Fehler: ${error.message}</span>`);
                return false;
            }
        }
        
        async function startAutoSetup() {
            if (setupComplete) return;
            
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.textContent = 'Setup l√§uft...';
            
            try {
                log('üöÄ Starte Auto-Setup...');
                
                // Schritt 1: Firebase initialisieren
                const firebaseOk = await initializeFirebase();
                if (!firebaseOk) throw new Error('Firebase-Initialisierung fehlgeschlagen');
                
                // Schritt 2: Collections erstellen
                const collectionsOk = await createCollections();
                if (!collectionsOk) throw new Error('Collection-Erstellung fehlgeschlagen');
                
                // Schritt 3: Test-Daten erstellen
                const testDataOk = await createTestData();
                if (!testDataOk) throw new Error('Test-Daten-Erstellung fehlgeschlagen');
                
                // Schritt 4: Verifikation
                const verifyOk = await verifySetup();
                if (!verifyOk) throw new Error('Verifikation fehlgeschlagen');
                
                log('üéâ Auto-Setup erfolgreich abgeschlossen!', 'success');
                
            } catch (error) {
                log(`‚ùå Setup fehlgeschlagen: ${error.message}`, 'error');
                document.getElementById('main-status').innerHTML = `
                    <span class="error">‚ùå <strong>Setup fehlgeschlagen:</strong> ${error.message}</span><br>
                    Bitte versuche es erneut oder kontaktiere den Support.
                `;
            } finally {
                startBtn.disabled = false;
                if (!setupComplete) {
                    startBtn.textContent = 'üîÑ Erneut versuchen';
                }
            }
        }
        
        async function checkStatus() {
            log('Pr√ºfe aktuellen Status...');
            
            if (!db) {
                const firebaseOk = await initializeFirebase();
                if (!firebaseOk) return;
            }
            
            await verifySetup();
        }
        
        // Auto-Start beim Laden
        document.addEventListener('DOMContentLoaded', () => {
            log('Auto-Setup Tool geladen');
            setTimeout(() => {
                log('Bereit f√ºr Setup. Klicke "Auto-Setup starten" um zu beginnen.');
            }, 1000);
        });
    </script>
</body>
</html>