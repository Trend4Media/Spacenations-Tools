<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard (Beispiel)</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      .kpis { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-top: 1rem; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; text-align: center; }
      .big { font-size: 2rem; font-weight: 700; }
      .err { color: #b00020; }
      .ok { color: #0a7f24; }
    </style>
  </head>
  <body>
    <h1>Admin Dashboard</h1>
    <p id="status">Lade...</p>
    <div class="kpis">
      <div class="card"><div>Nutzer</div><div id="kUsers" class="big">–</div></div>
      <div class="card"><div>Allianzen</div><div id="kAlliances" class="big">–</div></div>
      <div class="card"><div>Spy Reports</div><div id="kSpies" class="big">–</div></div>
    </div>
    <p><a href="/examples/firebase-login.html">Zurück zum Login</a></p>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="/js/firebase-config.js"></script>
    <script>
      async function load() {
        const el = (id) => document.getElementById(id);
        try {
          await window.FirebaseConfig.waitForReady();
          const db = window.FirebaseConfig.getDB();
          const auth = window.FirebaseConfig.getAuth();
          const uid = auth.currentUser && auth.currentUser.uid;
          if (!uid) { el('status').innerHTML = '<span class="err">Nicht eingeloggt.</span>'; return; }

          // Prüfe Global-Admin (einfacher Client-Check, echte Durchsetzung via Rules/Functions)
          const me = await db.collection('users').doc(uid).get();
          if (!me.exists || me.data().globalRole !== 'global_admin') {
            el('status').innerHTML = '<span class="err">Keine Admin-Berechtigung.</span>';
            return;
          }

          // Leichtgewichtige Zählungen (kosten Reads) – für Produktion besser Cloud Function verwenden
          const [u, a, s] = await Promise.all([
            db.collection('users').limit(1_000).get(),
            db.collection('alliances').limit(1_000).get(),
            db.collection('spyReports').limit(1_000).get()
          ]);
          el('kUsers').textContent = u.size;
          el('kAlliances').textContent = a.size;
          el('kSpies').textContent = s.size;
          el('status').innerHTML = '<span class="ok">Geladen.</span>';
        } catch (err) {
          document.getElementById('status').innerHTML = '<span class="err">' + (err && err.message ? err.message : 'Fehler') + '</span>';
        }
      }
      load();
    </script>
  </body>
  </html>

