<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Allianz Dashboard (Beispiel)</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      input, button { padding: .6rem .8rem; }
      table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
      th, td { border-bottom: 1px solid #eee; padding: .5rem .25rem; text-align: left; }
      .err { color: #b00020; }
      .ok { color: #0a7f24; }
    </style>
  </head>
  <body>
    <h1>Allianz Dashboard</h1>
    <label>Allianz-ID: <input id="allianceId" placeholder="alliances/<id> oder nur ID" /></label>
    <button id="load">Laden</button>
    <div id="status"></div>

    <h3>Spy-Report anlegen</h3>
    <div>
      <input id="player" placeholder="Spieler" />
      <input id="planet" placeholder="Planet" />
      <input id="coords" placeholder="Koordinaten" />
      <button id="save">Speichern</button>
    </div>

    <table>
      <thead>
        <tr><th>Spieler</th><th>Planet</th><th>Koords</th><th>Datum</th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <p><a href="/examples/firebase-login.html">Zur√ºck zum Login</a></p>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="/js/firebase-config.js"></script>
    <script>
      const el = (id) => document.getElementById(id);

      async function loadAlliance() {
        el('rows').innerHTML = '';
        try {
          await window.FirebaseConfig.waitForReady();
          const db = window.FirebaseConfig.getDB();
          const id = el('allianceId').value.trim().replace(/^alliances\//,'');
          if (!id) return;

          const aDoc = await db.collection('alliances').doc(id).get();
          if (!aDoc.exists) {
            el('status').innerHTML = '<span class="err">Allianz nicht gefunden oder keine Berechtigung.</span>';
            return;
          }
          el('status').innerHTML = `<span class="ok">Geladen: ${aDoc.data().name || id}</span>`;

          const q = db.collection('spyReports')
            .where('allianceId','==',id)
            .orderBy('createdAt','desc')
            .limit(50);
          const snap = await q.get();
          const rows = [];
          snap.forEach(d => {
            const r = d.data();
            const dt = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
            rows.push(`<tr><td>${r.playerName||'-'}</td><td>${r.planetName||'-'}</td><td>${r.planetCoordinates||'-'}</td><td>${dt.toLocaleString()}</td></tr>`);
          });
          el('rows').innerHTML = rows.join('');
        } catch (err) {
          el('status').innerHTML = '<span class="err">' + (err && err.message ? err.message : 'Fehler') + '</span>';
        }
      }

      async function saveReport() {
        try {
          await window.FirebaseConfig.waitForReady();
          const auth = window.FirebaseConfig.getAuth();
          const db = window.FirebaseConfig.getDB();
          const uid = auth.currentUser && auth.currentUser.uid;
          const id = el('allianceId').value.trim().replace(/^alliances\//,'');
          if (!uid || !id) return;
          await db.collection('spyReports').add({
            allianceId: id,
            createdByUid: uid,
            playerName: el('player').value || null,
            planetName: el('planet').value || null,
            planetCoordinates: el('coords').value || null,
            createdAt: new Date()
          });
          el('status').innerHTML = '<span class="ok">Gespeichert.</span>';
          await loadAlliance();
        } catch (err) {
          el('status').innerHTML = '<span class="err">' + (err && err.message ? err.message : 'Fehler beim Speichern') + '</span>';
        }
      }

      el('load').addEventListener('click', loadAlliance);
      el('save').addEventListener('click', saveReport);
    </script>
  </body>
  </html>

