<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Member Dashboard (Beispiel)</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border-bottom: 1px solid #eee; padding: .5rem .25rem; text-align: left; }
      .err { color: #b00020; }
      .ok { color: #0a7f24; }
    </style>
  </head>
  <body>
    <h1>Member Dashboard</h1>
    <p id="welcome">Lade...</p>
    <div class="grid">
      <div class="card">
        <h3>Meine Allianzen</h3>
        <ul id="alliances"></ul>
      </div>
      <div class="card">
        <h3>Letzte Spy-Reports</h3>
        <table>
          <thead>
            <tr><th>Allianz</th><th>Spieler</th><th>Planet</th><th>Koords</th><th>Datum</th></tr>
          </thead>
          <tbody id="spyRows"></tbody>
        </table>
      </div>
    </div>
    <p id="status"></p>

    <p><a href="/examples/firebase-login.html">Zurück zum Login</a></p>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="/js/firebase-config.js"></script>
    <script>
      const el = (id) => document.getElementById(id);

      async function load() {
        try {
          await window.FirebaseConfig.waitForReady();
          const auth = window.FirebaseConfig.getAuth();
          const db = window.FirebaseConfig.getDB();
          const user = auth.currentUser;
          if (!user) {
            el('status').innerHTML = '<span class="err">Nicht eingeloggt.</span>';
            return;
          }
          el('welcome').textContent = `Willkommen, ${user.email}`;

          // Mitgliedschaften laden
          const memberSnap = await db.collection('allianceMembers').where('uid','==',user.uid).get();
          const alliances = [];
          const allianceIds = [];
          memberSnap.forEach(doc => { alliances.push(doc.data()); allianceIds.push(doc.data().allianceId); });
          el('alliances').innerHTML = alliances.map(a => `<li>${a.allianceId} – Rolle: ${a.role}</li>`).join('') || '<li>Keine Allianz</li>';

          // Reports sammeln (je Allianz)
          const rows = [];
          for (const aId of allianceIds) {
            const q = db.collection('spyReports')
              .where('allianceId','==',aId)
              .orderBy('createdAt','desc')
              .limit(10);
            const snap = await q.get();
            snap.forEach(d => {
              const r = d.data();
              const dt = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
              rows.push(`<tr><td>${aId}</td><td>${r.playerName||'-'}</td><td>${r.planetName||'-'}</td><td>${r.planetCoordinates||'-'}</td><td>${dt.toLocaleString()}</td></tr>`);
            });
          }
          el('spyRows').innerHTML = rows.join('');
          el('status').innerHTML = '<span class="ok">Geladen.</span>';
        } catch (err) {
          el('status').innerHTML = '<span class="err">' + (err && err.message ? err.message : 'Fehler beim Laden') + '</span>';
        }
      }

      load();
    </script>
  </body>
  </html>

