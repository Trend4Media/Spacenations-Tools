<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datenbank-Zugriff Diagnose - Spacenations Tools</title>
    <style>
        :root {
            --primary: #00FF88;
            --bg-dark: #0A0A0A;
            --bg-card: #111111;
            --border: rgba(0, 255, 136, 0.2);
            --text-primary: #FFFFFF;
            --text-secondary: #C0C0C0;
            --error: #FF4444;
            --success: #00FF88;
            --warning: #FFA500;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .alert-box {
            background: rgba(255, 165, 0, 0.1);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .alert-box h3 {
            color: var(--warning);
            margin-bottom: 12px;
        }
        
        .section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .section h3 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 20px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 8px 8px 0;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #00CC6A;
            transform: translateY(-2px);
        }
        
        .btn.secondary {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn.secondary:hover {
            background: var(--primary);
            color: var(--bg-dark);
        }
        
        .result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        
        .result.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--success);
        }
        
        .result.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--error);
        }
        
        .result.warning {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            color: var(--warning);
        }
        
        .result.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .status-card h4 {
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .status-indicator {
            font-size: 48px;
            margin: 16px 0;
        }
        
        .code-block {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üîç Datenbank-Zugriff Diagnose</h1>
            <p class="subtitle">Detaillierte Analyse der Firebase-Datenbankverbindung</p>
        </div>
        
        <div class="alert-box">
            <h3>üìã Diagnose-Ergebnis</h3>
            <p><strong>‚úÖ Firebase-Konfiguration ist KORREKT</strong> - Das System zeigt auf die richtige Projekt-ID <code>spacenations-tools</code>.</p>
            <p>Das Problem liegt <strong>nicht</strong> an der falschen Datenbank, sondern wahrscheinlich an:</p>
            <ul style="margin-top: 12px; padding-left: 20px;">
                <li>Firestore-Sicherheitsregeln</li>
                <li>Browser-Cache oder Service Worker</li>
                <li>Netzwerkverbindung zur Firebase-API</li>
                <li>Authentifizierungsprobleme</li>
            </ul>
        </div>
        
        <div class="grid">
            <div class="status-card">
                <h4>üîß Firebase Config</h4>
                <div class="status-indicator">‚úÖ</div>
                <p>Projekt-ID: spacenations-tools</p>
                <p>Status: Korrekt konfiguriert</p>
            </div>
            
            <div class="status-card">
                <h4>üîó Datenbankverbindung</h4>
                <div class="status-indicator" id="db-status">‚ùì</div>
                <p id="db-status-text">Teste Verbindung...</p>
            </div>
            
            <div class="status-card">
                <h4>üîí Authentifizierung</h4>
                <div class="status-indicator" id="auth-status">‚ùì</div>
                <p id="auth-status-text">Teste Auth-Status...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>üß™ Detaillierte Diagnose-Tests</h3>
            <p>F√ºhren Sie diese Tests durch, um die genaue Ursache des Problems zu identifizieren:</p>
            
            <button class="btn" onclick="testFirebaseConnection()">Firebase-Verbindung testen</button>
            <button class="btn" onclick="testFirestoreAccess()">Firestore-Zugriff testen</button>
            <button class="btn" onclick="testUserActivities()">userActivities Collection testen</button>
            <button class="btn" onclick="testAuthentication()">Authentifizierung testen</button>
            <div id="detailed-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üîí Firestore-Sicherheitsregeln pr√ºfen</h3>
            <p>Die wahrscheinlichste Ursache sind zu restriktive Firestore-Sicherheitsregeln:</p>
            
            <button class="btn" onclick="checkSecurityRules()">Sicherheitsregeln pr√ºfen</button>
            <button class="btn secondary" onclick="showRulesFix()">Regeln-Fix anzeigen</button>
            <div id="rules-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üßπ Cache & Browser-Probleme</h3>
            <p>Browser-Cache und Service Worker k√∂nnen veraltete Konfigurationen verwenden:</p>
            
            <button class="btn" onclick="checkBrowserCache()">Browser-Cache pr√ºfen</button>
            <button class="btn" onclick="clearBrowserData()">Cache-L√∂sung anzeigen</button>
            <div id="cache-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üåê Netzwerk & API-Tests</h3>
            <p>Teste die Netzwerkverbindung zu Firebase-Services:</p>
            
            <button class="btn" onclick="testNetworkConnection()">Netzwerk testen</button>
            <button class="btn" onclick="testFirebaseAPI()">Firebase API testen</button>
            <div id="network-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üõ†Ô∏è Sofortl√∂sungen</h3>
            <p>Schnelle L√∂sungsans√§tze zum Ausprobieren:</p>
            
            <div class="grid">
                <div>
                    <h4>1. Hard Refresh</h4>
                    <p>Dr√ºcken Sie <code>Ctrl+Shift+R</code> (Windows) oder <code>Cmd+Shift+R</code> (Mac)</p>
                </div>
                <div>
                    <h4>2. Inkognito-Modus</h4>
                    <p>Testen Sie die Anwendung im privaten/inkognito Browserfenster</p>
                </div>
                <div>
                    <h4>3. Service Worker deaktivieren</h4>
                    <p>F12 ‚Üí Application ‚Üí Service Workers ‚Üí Unregister</p>
                </div>
                <div>
                    <h4>4. Andere Browser testen</h4>
                    <p>Versuchen Sie Chrome, Firefox oder Safari</p>
                </div>
            </div>
        </div>
        
        <div id="overall-diagnosis" class="section" style="display: none;">
            <h3>üìä Gesamtdiagnose</h3>
            <div id="diagnosis-content"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    
    <script>
        // Utility functions
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function updateStatusCard(statusId, textId, status, message) {
            const statusEl = document.getElementById(statusId);
            const textEl = document.getElementById(textId);
            
            if (statusEl) statusEl.textContent = status;
            if (textEl) textEl.textContent = message;
        }
        
        async function waitForFirebase() {
            if (!window.FirebaseConfig) {
                await new Promise(resolve => {
                    const checkFirebase = setInterval(() => {
                        if (window.FirebaseConfig) {
                            clearInterval(checkFirebase);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            try {
                await window.FirebaseConfig.waitForReady();
            } catch (error) {
                console.warn('Firebase wait failed:', error);
            }
        }
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                showResult('detailed-result', 'üîÑ Teste Firebase-Verbindung...', 'info');
                
                await waitForFirebase();
                
                let result = 'üîç Firebase-Verbindungstest:\n\n';
                
                // Check Firebase availability
                if (typeof firebase === 'undefined') {
                    result += '‚ùå Firebase SDK nicht geladen\n';
                    updateStatusCard('db-status', 'db-status-text', '‚ùå', 'Firebase SDK fehlt');
                    showResult('detailed-result', result, 'error');
                    return;
                }
                
                // Check app configuration
                const app = firebase.app();
                const config = app.options;
                
                result += 'üìã Firebase App Status:\n';
                result += `‚Ä¢ App Name: ${app.name}\n`;
                result += `‚Ä¢ Projekt-ID: ${config.projectId}\n`;
                result += `‚Ä¢ Auth Domain: ${config.authDomain}\n`;
                result += `‚Ä¢ Initialisiert: ‚úÖ\n\n`;
                
                // Test Firestore
                try {
                    const db = firebase.firestore();
                    result += 'üîó Firestore-Verbindung:\n';
                    result += '‚Ä¢ Firestore-Instanz: ‚úÖ Erstellt\n';
                    
                    // Test basic connection with a simple read
                    try {
                        await db.collection('_test').doc('connection').get();
                        result += '‚Ä¢ Grundverbindung: ‚úÖ Funktioniert\n';
                        updateStatusCard('db-status', 'db-status-text', '‚úÖ', 'Verbindung OK');
                    } catch (readError) {
                        result += `‚Ä¢ Grundverbindung: ‚ùå ${readError.message}\n`;
                        updateStatusCard('db-status', 'db-status-text', '‚ùå', 'Verbindungsfehler');
                        
                        if (readError.code === 'permission-denied') {
                            result += '\nüîí SICHERHEITSREGELN-PROBLEM ERKANNT!\n';
                            result += 'Die Firestore-Sicherheitsregeln blockieren den Zugriff.\n';
                        }
                    }
                    
                } catch (firestoreError) {
                    result += `‚ùå Firestore-Initialisierung fehlgeschlagen: ${firestoreError.message}\n`;
                    updateStatusCard('db-status', 'db-status-text', '‚ùå', 'Firestore-Fehler');
                }
                
                showResult('detailed-result', result, 'info');
                
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                showResult('detailed-result', `‚ùå Firebase-Verbindungstest fehlgeschlagen:\n${error.message}`, 'error');
                updateStatusCard('db-status', 'db-status-text', '‚ùå', 'Test fehlgeschlagen');
            }
        }
        
        // Test Firestore access
        async function testFirestoreAccess() {
            try {
                showResult('detailed-result', 'üîÑ Teste Firestore-Zugriff...', 'info');
                
                await waitForFirebase();
                
                const db = window.FirebaseConfig?.getDB();
                if (!db) {
                    showResult('detailed-result', '‚ùå Firestore-Datenbank nicht verf√ºgbar', 'error');
                    return;
                }
                
                let result = 'üîç Firestore-Zugriffstest:\n\n';
                
                // Test different collections
                const collections = [
                    { name: 'users', description: 'Benutzer-Daten' },
                    { name: 'userActivities', description: 'Benutzer-Aktivit√§ten' },
                    { name: 'alliances', description: 'Allianz-Daten' },
                    { name: 'userStats', description: 'Benutzer-Statistiken' }
                ];
                
                for (const collection of collections) {
                    try {
                        result += `üìÅ ${collection.name} (${collection.description}):\n`;
                        
                        const snapshot = await db.collection(collection.name).limit(1).get();
                        result += `  ‚Ä¢ Lesezugriff: ‚úÖ\n`;
                        result += `  ‚Ä¢ Dokumente: ${snapshot.size}\n`;
                        
                        if (collection.name === 'userActivities' && snapshot.size === 0) {
                            result += `  ‚Ä¢ ‚ö†Ô∏è Keine userActivities gefunden - das erkl√§rt das Problem!\n`;
                        }
                        
                    } catch (error) {
                        result += `  ‚Ä¢ Lesezugriff: ‚ùå ${error.message}\n`;
                        
                        if (error.code === 'permission-denied') {
                            result += `  ‚Ä¢ üîí Berechtigungsproblem!\n`;
                        }
                    }
                    result += '\n';
                }
                
                showResult('detailed-result', result, 'info');
                
            } catch (error) {
                console.error('Firestore access test failed:', error);
                showResult('detailed-result', `‚ùå Firestore-Zugriffstest fehlgeschlagen:\n${error.message}`, 'error');
            }
        }
        
        // Test userActivities specifically
        async function testUserActivities() {
            try {
                showResult('detailed-result', 'üîÑ Teste userActivities Collection...', 'info');
                
                await waitForFirebase();
                
                const db = window.FirebaseConfig?.getDB();
                if (!db) {
                    showResult('detailed-result', '‚ùå Firestore-Datenbank nicht verf√ºgbar', 'error');
                    return;
                }
                
                let result = 'üîç userActivities Collection Test:\n\n';
                
                try {
                    // Test read access
                    const snapshot = await db.collection('userActivities')
                        .orderBy('timestamp', 'desc')
                        .limit(5)
                        .get();
                    
                    result += `üìä Collection-Status:\n`;
                    result += `‚Ä¢ Lesezugriff: ‚úÖ Erfolgreich\n`;
                    result += `‚Ä¢ Gefundene Dokumente: ${snapshot.size}\n\n`;
                    
                    if (snapshot.size === 0) {
                        result += `‚ö†Ô∏è PROBLEM IDENTIFIZIERT:\n`;
                        result += `Die userActivities Collection ist LEER!\n`;
                        result += `Das erkl√§rt, warum keine Aktivit√§ten angezeigt werden.\n\n`;
                        
                        result += `üõ†Ô∏è M√∂gliche Ursachen:\n`;
                        result += `‚Ä¢ Noch keine Benutzeraktivit√§ten erstellt\n`;
                        result += `‚Ä¢ Daten wurden versehentlich gel√∂scht\n`;
                        result += `‚Ä¢ Schreibzugriff funktioniert nicht\n`;
                        result += `‚Ä¢ Falsche Collection-Namen\n\n`;
                        
                        // Test write access
                        try {
                            result += `üß™ Teste Schreibzugriff...\n`;
                            const testDoc = {
                                userId: 'test-user',
                                icon: 'üß™',
                                text: 'Diagnose-Test',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            await db.collection('userActivities').add(testDoc);
                            result += `‚Ä¢ Schreibzugriff: ‚úÖ Funktioniert\n`;
                            result += `‚Ä¢ Test-Dokument erstellt\n`;
                            
                            // Clean up test document
                            setTimeout(async () => {
                                try {
                                    const testDocs = await db.collection('userActivities')
                                        .where('userId', '==', 'test-user')
                                        .get();
                                    testDocs.forEach(doc => doc.ref.delete());
                                } catch (e) {
                                    console.warn('Could not clean up test document:', e);
                                }
                            }, 5000);
                            
                        } catch (writeError) {
                            result += `‚Ä¢ Schreibzugriff: ‚ùå ${writeError.message}\n`;
                            if (writeError.code === 'permission-denied') {
                                result += `‚Ä¢ üîí Schreibberechtigung verweigert!\n`;
                            }
                        }
                        
                    } else {
                        result += `‚úÖ Collection enth√§lt Daten:\n`;
                        snapshot.forEach((doc, index) => {
                            const data = doc.data();
                            const timestamp = data.timestamp?.toDate?.() || new Date(data.timestamp);
                            result += `${index + 1}. ${data.icon || 'üìù'} ${data.text || 'Keine Beschreibung'}\n`;
                            result += `   User: ${data.userId || 'Unbekannt'}\n`;
                            result += `   Zeit: ${timestamp.toLocaleString('de-DE')}\n\n`;
                        });
                    }
                    
                } catch (error) {
                    result += `‚ùå Fehler beim Zugriff auf userActivities:\n`;
                    result += `${error.message}\n\n`;
                    
                    if (error.code === 'permission-denied') {
                        result += `üîí BERECHTIGUNGSPROBLEM:\n`;
                        result += `Die Firestore-Sicherheitsregeln verhindern den Zugriff\n`;
                        result += `auf die userActivities Collection.\n\n`;
                        
                        result += `üõ†Ô∏è L√∂sung:\n`;
                        result += `1. Firestore-Sicherheitsregeln √ºberpr√ºfen\n`;
                        result += `2. Regel f√ºr userActivities hinzuf√ºgen/anpassen\n`;
                        result += `3. Authentifizierung pr√ºfen\n`;
                    } else if (error.code === 'failed-precondition') {
                        result += `üìã INDEX-PROBLEM:\n`;
                        result += `Ein Index f√ºr die Abfrage fehlt.\n`;
                        result += `Firebase sollte automatisch einen Index-Link bereitstellen.\n`;
                    }
                }
                
                showResult('detailed-result', result, 'info');
                
            } catch (error) {
                console.error('UserActivities test failed:', error);
                showResult('detailed-result', `‚ùå userActivities-Test fehlgeschlagen:\n${error.message}`, 'error');
            }
        }
        
        // Test authentication
        async function testAuthentication() {
            try {
                showResult('detailed-result', 'üîÑ Teste Authentifizierung...', 'info');
                
                await waitForFirebase();
                
                let result = 'üîç Authentifizierungs-Test:\n\n';
                
                // Check AuthAPI
                if (window.AuthAPI) {
                    result += '‚úÖ AuthAPI verf√ºgbar\n';
                    
                    const currentUser = window.AuthAPI.getCurrentUser();
                    const userData = window.AuthAPI.getUserData();
                    
                    result += `üìã Auth-Status:\n`;
                    result += `‚Ä¢ Angemeldet: ${currentUser ? '‚úÖ Ja' : '‚ùå Nein'}\n`;
                    
                    if (currentUser) {
                        result += `‚Ä¢ Benutzer-ID: ${currentUser.uid}\n`;
                        result += `‚Ä¢ E-Mail: ${currentUser.email}\n`;
                        result += `‚Ä¢ Benutzerdaten geladen: ${userData ? '‚úÖ' : '‚ùå'}\n`;
                        
                        if (userData) {
                            result += `‚Ä¢ Username: ${userData.username || 'Nicht gesetzt'}\n`;
                            result += `‚Ä¢ Rolle: ${userData.systemRole || userData.role || 'user'}\n`;
                            result += `‚Ä¢ Super-Admin: ${userData.isSuperAdmin ? '‚úÖ' : '‚ùå'}\n`;
                        }
                        
                        updateStatusCard('auth-status', 'auth-status-text', '‚úÖ', `Angemeldet: ${currentUser.email}`);
                    } else {
                        result += '\n‚ö†Ô∏è Nicht angemeldet - das k√∂nnte das Problem sein!\n';
                        result += 'Viele Firestore-Operationen erfordern eine Authentifizierung.\n';
                        updateStatusCard('auth-status', 'auth-status-text', '‚ùå', 'Nicht angemeldet');
                    }
                    
                } else {
                    result += '‚ùå AuthAPI nicht verf√ºgbar\n';
                    updateStatusCard('auth-status', 'auth-status-text', '‚ùå', 'AuthAPI fehlt');
                }
                
                // Check Firebase Auth
                try {
                    const auth = firebase.auth();
                    result += `\nüîê Firebase Auth:\n`;
                    result += `‚Ä¢ Auth-Instanz: ‚úÖ Verf√ºgbar\n`;
                    result += `‚Ä¢ Aktueller User: ${auth.currentUser ? auth.currentUser.email : 'Nicht angemeldet'}\n`;
                } catch (authError) {
                    result += `\n‚ùå Firebase Auth Fehler: ${authError.message}\n`;
                }
                
                showResult('detailed-result', result, 'info');
                
            } catch (error) {
                console.error('Authentication test failed:', error);
                showResult('detailed-result', `‚ùå Authentifizierungs-Test fehlgeschlagen:\n${error.message}`, 'error');
                updateStatusCard('auth-status', 'auth-status-text', '‚ùå', 'Test fehlgeschlagen');
            }
        }
        
        // Check security rules
        async function checkSecurityRules() {
            const result = `üîí Firestore-Sicherheitsregeln Diagnose:

üìã Wahrscheinlichste Ursache:
Die Firestore-Sicherheitsregeln sind zu restriktiv und blockieren
den Zugriff auf die userActivities Collection.

üîç Typische Probleme:
‚Ä¢ Regel verlangt Authentifizierung, aber User ist nicht angemeldet
‚Ä¢ Regel erlaubt nur Zugriff auf eigene Daten, aber Query ist zu breit
‚Ä¢ Regel fehlt komplett f√ºr userActivities Collection
‚Ä¢ Regel hat Syntax-Fehler

üõ†Ô∏è Sofort-Checks:
1. Melden Sie sich im Admin-Login an
2. Testen Sie erneut den Zugriff auf userActivities
3. Pr√ºfen Sie die Firestore-Regeln in der Firebase Console

üåê Firebase Console Links:
‚Ä¢ Firestore Rules: https://console.firebase.google.com/project/spacenations-tools/firestore/rules
‚Ä¢ Firestore Data: https://console.firebase.google.com/project/spacenations-tools/firestore/data

üí° Empfohlene Regel f√ºr Tests:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Tempor√§re Test-Regel (NICHT f√ºr Produktion!)
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`;

            showResult('rules-result', result, 'warning');
        }
        
        // Show rules fix
        async function showRulesFix() {
            const result = `üõ†Ô∏è Firestore-Sicherheitsregeln reparieren:

üìã Schritt 1: Firebase Console √∂ffnen
‚Ä¢ https://console.firebase.google.com/project/spacenations-tools/firestore/rules

üìã Schritt 2: Aktuelle Regeln √ºberpr√ºfen
‚Ä¢ Klicken Sie auf "Rules" Tab
‚Ä¢ √úberpr√ºfen Sie die bestehenden Regeln

üìã Schritt 3: Regel f√ºr userActivities hinzuf√ºgen
F√ºgen Sie diese Regel hinzu:

match /userActivities/{activityId} {
  allow read: if request.auth != null;
  allow write: if request.auth != null && 
               request.auth.uid == request.resource.data.userId;
}

üìã Schritt 4: Regel f√ºr users Collection
match /users/{userId} {
  allow read: if request.auth != null;
  allow write: if request.auth != null && 
               (request.auth.uid == userId || 
                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true);
}

üìã Schritt 5: Regeln ver√∂ffentlichen
‚Ä¢ Klicken Sie auf "Publish"
‚Ä¢ Warten Sie auf Best√§tigung

üìã Schritt 6: Testen
‚Ä¢ Melden Sie sich im Admin-Login an
‚Ä¢ Testen Sie den Zugriff auf userActivities

‚ö†Ô∏è F√ºr Entwicklung/Tests:
Tempor√§r k√∂nnen Sie alle Zugriffe erlauben:
allow read, write: if true;

üîí F√ºr Produktion:
Verwenden Sie immer spezifische, sichere Regeln!`;

            showResult('rules-result', result, 'info');
        }
        
        // Check browser cache
        async function checkBrowserCache() {
            let result = 'üßπ Browser-Cache Diagnose:\n\n';
            
            // Check localStorage
            const localStorageItems = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('firebase') || key.includes('auth') || key.includes('user')) {
                    localStorageItems.push(key);
                }
            }
            
            result += `üì¶ LocalStorage:\n`;
            result += `‚Ä¢ Firebase-bezogene Items: ${localStorageItems.length}\n`;
            if (localStorageItems.length > 0) {
                result += `‚Ä¢ Items: ${localStorageItems.join(', ')}\n`;
            }
            
            // Check sessionStorage
            const sessionStorageItems = [];
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key.includes('firebase') || key.includes('auth') || key.includes('user')) {
                    sessionStorageItems.push(key);
                }
            }
            
            result += `\nüì¶ SessionStorage:\n`;
            result += `‚Ä¢ Firebase-bezogene Items: ${sessionStorageItems.length}\n`;
            if (sessionStorageItems.length > 0) {
                result += `‚Ä¢ Items: ${sessionStorageItems.join(', ')}\n`;
            }
            
            // Check for service workers
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    result += `\nüîß Service Workers:\n`;
                    result += `‚Ä¢ Registrierte SW: ${registrations.length}\n`;
                    
                    if (registrations.length > 0) {
                        result += `‚ö†Ô∏è Service Worker k√∂nnen veraltete Daten cachen!\n`;
                    }
                } catch (e) {
                    result += `\nüîß Service Workers: Pr√ºfung fehlgeschlagen\n`;
                }
            }
            
            // Check cache API
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    result += `\nüíæ Cache API:\n`;
                    result += `‚Ä¢ Gefundene Caches: ${cacheNames.length}\n`;
                    if (cacheNames.length > 0) {
                        result += `‚Ä¢ Cache-Namen: ${cacheNames.join(', ')}\n`;
                    }
                } catch (e) {
                    result += `\nüíæ Cache API: Pr√ºfung fehlgeschlagen\n`;
                }
            }
            
            showResult('cache-result', result, 'info');
        }
        
        // Clear browser data solution
        async function clearBrowserData() {
            const result = `üßπ Browser-Daten l√∂schen - Anleitung:

üìã Methode 1: Hard Refresh
‚Ä¢ Windows/Linux: Ctrl + Shift + R
‚Ä¢ Mac: Cmd + Shift + R
‚Ä¢ Dies l√§dt die Seite neu und umgeht den Cache

üìã Methode 2: Developer Tools
1. F12 dr√ºcken (Developer Tools √∂ffnen)
2. Rechtsklick auf Reload-Button
3. "Empty Cache and Hard Reload" w√§hlen

üìã Methode 3: Browser-Einstellungen
Chrome:
1. Einstellungen ‚Üí Erweitert ‚Üí Datenschutz und Sicherheit
2. "Browserdaten l√∂schen"
3. "Bilder und Dateien im Cache" ausw√§hlen
4. Zeitraum: "Letzte Stunde" oder "Alles"

Firefox:
1. Einstellungen ‚Üí Datenschutz & Sicherheit
2. "Daten l√∂schen"
3. "Zwischengespeicherte Webinhalte" ausw√§hlen

üìã Methode 4: Inkognito/Privat-Modus
‚Ä¢ √ñffnen Sie die Anwendung im privaten Browserfenster
‚Ä¢ Dadurch werden alle Caches umgangen

üìã Methode 5: Service Worker deaktivieren
1. F12 ‚Üí Application Tab
2. Service Workers ‚Üí Unregister all
3. Seite neu laden

üìã Methode 6: Komplette Browser-Daten
‚ö†Ô∏è Vorsicht: L√∂scht alle gespeicherten Daten!
1. localStorage.clear()
2. sessionStorage.clear()
3. Alle Cookies f√ºr die Domain l√∂schen

üîÑ Nach dem L√∂schen:
‚Ä¢ Seite komplett neu laden
‚Ä¢ Ggf. neu anmelden
‚Ä¢ Funktionalit√§t testen`;

            showResult('cache-result', result, 'info');
        }
        
        // Test network connection
        async function testNetworkConnection() {
            try {
                showResult('network-result', 'üîÑ Teste Netzwerkverbindung...', 'info');
                
                let result = 'üåê Netzwerk-Diagnose:\n\n';
                
                // Test Firebase API endpoints
                const endpoints = [
                    { name: 'Firebase Config API', url: '/api/firebase-config' },
                    { name: 'Google APIs', url: 'https://www.googleapis.com/' },
                    { name: 'Firebase Auth', url: 'https://identitytoolkit.googleapis.com/' }
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        const startTime = Date.now();
                        const response = await fetch(endpoint.url, { 
                            method: 'HEAD',
                            mode: 'no-cors'
                        });
                        const duration = Date.now() - startTime;
                        
                        result += `üîó ${endpoint.name}:\n`;
                        result += `  ‚Ä¢ Status: ‚úÖ Erreichbar\n`;
                        result += `  ‚Ä¢ Antwortzeit: ${duration}ms\n\n`;
                        
                    } catch (error) {
                        result += `üîó ${endpoint.name}:\n`;
                        result += `  ‚Ä¢ Status: ‚ùå ${error.message}\n\n`;
                    }
                }
                
                // Test browser connectivity
                result += `üì° Browser-Konnektivit√§t:\n`;
                result += `‚Ä¢ Online: ${navigator.onLine ? '‚úÖ' : '‚ùå'}\n`;
                result += `‚Ä¢ Connection: ${navigator.connection ? navigator.connection.effectiveType : 'Unbekannt'}\n\n`;
                
                // Test CORS
                try {
                    const corsTest = await fetch('/api/firebase-config');
                    if (corsTest.ok) {
                        result += `üîê CORS-Test: ‚úÖ OK\n`;
                    } else {
                        result += `üîê CORS-Test: ‚ö†Ô∏è Status ${corsTest.status}\n`;
                    }
                } catch (corsError) {
                    result += `üîê CORS-Test: ‚ùå ${corsError.message}\n`;
                }
                
                showResult('network-result', result, 'info');
                
            } catch (error) {
                console.error('Network test failed:', error);
                showResult('network-result', `‚ùå Netzwerk-Test fehlgeschlagen:\n${error.message}`, 'error');
            }
        }
        
        // Test Firebase API
        async function testFirebaseAPI() {
            try {
                showResult('network-result', 'üîÑ Teste Firebase API...', 'info');
                
                let result = 'üî• Firebase API Test:\n\n';
                
                // Test config endpoint
                try {
                    const configResponse = await fetch('/api/firebase-config');
                    if (configResponse.ok) {
                        const config = await configResponse.json();
                        result += `üìã Config API:\n`;
                        result += `  ‚Ä¢ Status: ‚úÖ OK\n`;
                        result += `  ‚Ä¢ Projekt-ID: ${config.projectId}\n`;
                        result += `  ‚Ä¢ Auth Domain: ${config.authDomain}\n\n`;
                    } else {
                        result += `üìã Config API: ‚ùå Status ${configResponse.status}\n\n`;
                    }
                } catch (configError) {
                    result += `üìã Config API: ‚ùå ${configError.message}\n\n`;
                }
                
                // Test Firebase services
                if (typeof firebase !== 'undefined') {
                    result += `üî• Firebase Services:\n`;
                    result += `  ‚Ä¢ SDK geladen: ‚úÖ\n`;
                    result += `  ‚Ä¢ App initialisiert: ${firebase.apps.length > 0 ? '‚úÖ' : '‚ùå'}\n`;
                    
                    if (firebase.apps.length > 0) {
                        const app = firebase.app();
                        result += `  ‚Ä¢ App Name: ${app.name}\n`;
                        result += `  ‚Ä¢ Projekt-ID: ${app.options.projectId}\n`;
                    }
                } else {
                    result += `üî• Firebase Services: ‚ùå SDK nicht geladen\n`;
                }
                
                showResult('network-result', result, 'info');
                
            } catch (error) {
                console.error('Firebase API test failed:', error);
                showResult('network-result', `‚ùå Firebase API Test fehlgeschlagen:\n${error.message}`, 'error');
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Auto-run basic tests
                await testFirebaseConnection();
                await testAuthentication();
                
                // Show overall diagnosis
                const diagnosisEl = document.getElementById('overall-diagnosis');
                const contentEl = document.getElementById('diagnosis-content');
                
                contentEl.innerHTML = `
                    <div class="result info">
                        ‚úÖ Automatische Diagnose abgeschlossen<br><br>
                        
                        <strong>Ergebnis:</strong><br>
                        ‚Ä¢ Firebase-Konfiguration ist korrekt<br>
                        ‚Ä¢ System zeigt auf die richtige Datenbank<br>
                        ‚Ä¢ Problem liegt wahrscheinlich an Firestore-Sicherheitsregeln oder Authentifizierung<br><br>
                        
                        <strong>N√§chste Schritte:</strong><br>
                        1. Testen Sie "userActivities Collection" oben<br>
                        2. Pr√ºfen Sie die Firestore-Sicherheitsregeln<br>
                        3. Melden Sie sich im Admin-Login an<br>
                        4. Versuchen Sie einen Hard-Refresh (Ctrl+Shift+R)<br>
                    </div>
                `;
                diagnosisEl.style.display = 'block';
                
            } catch (error) {
                console.error('Auto-diagnosis failed:', error);
            }
        });
    </script>
</body>
</html>