<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap Super-Admin</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; background: #0b1020; color: #e5e7eb; margin: 0; min-height: 100vh; display: grid; place-items: center; padding: 20px; }
        .card { width: 100%; max-width: 520px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
        h1 { margin: 0 0 8px 0; color: #38bdf8; }
        p { margin: 8px 0; color: #9ca3af; }
        .row { margin: 12px 0; }
        label { display: block; font-size: 0.9rem; color: #9ca3af; margin-bottom: 6px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: #e5e7eb; }
        .btn { display: inline-block; padding: 12px 16px; border-radius: 10px; border: none; background: linear-gradient(135deg, #3a5998, #4a90e2); color: white; font-weight: 700; cursor: pointer; }
        .muted { font-size: 0.85rem; color: #9ca3af; }
        .ok { display:none; background: rgba(34,197,94,0.15); border: 1px solid #22c55e; color: #bbf7d0; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .err { display:none; background: rgba(239,68,68,0.15); border: 1px solid #ef4444; color: #fecaca; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .info { display:none; background: rgba(59,130,246,0.15); border: 1px solid #3b82f6; color: #dbeafe; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üõ°Ô∏è Bootstrap Super-Admin</h1>
        <p class="muted">Nur f√ºr initiales Setup. Entfernen Sie diese Seite nach erfolgreicher Vergabe.</p>

        <div id="msg-ok" class="ok"></div>
        <div id="msg-err" class="err"></div>
        <div id="msg-info" class="info"></div>

        <div class="row">
            <div class="muted">Status: <span id="status">L√§dt...</span></div>
            <div class="muted">Angemeldet als: <span id="current-user">-</span></div>
        </div>

        <div class="row">
            <label for="code">Bootstrap-Code</label>
            <input id="code" placeholder="Code eingeben" />
            <div class="muted">Tipp: Code kann via ?code=... in der URL mitgegeben werden.</div>
        </div>

        <div class="row">
            <button class="btn" id="promote-btn">Als Super-Admin setzen</button>
        </div>

        <div class="row">
            <a href="admin-login.html" class="muted">‚Üê Zum Admin-Login</a>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="js/firebase-config.js"></script>
    <script src="js/auth-manager.js"></script>

    <script>
        // Konfiguration
        const BOOTSTRAP_CODE = 'SN-BOOTSTRAP-2025-01';
        const ALLOWED_EMAILS = ['info@trend4media.de']; // anpassbar

        function show(elId, msg){ const el = document.getElementById(elId); el.textContent = msg; el.style.display = 'block'; }
        function hideAll(){ ['msg-ok','msg-err','msg-info'].forEach(id => document.getElementById(id).style.display='none'); }
        function qs(name){ return new URLSearchParams(location.search).get(name); }

        async function init(){
            await window.AuthAPI.waitForInit();
            window.AuthAPI.onAuthStateChange(async (user, data) => {
                document.getElementById('status').textContent = user ? 'Angemeldet' : 'Nicht angemeldet';
                document.getElementById('current-user').textContent = user ? (data?.email || user.email || data?.username || '-') : '-';
            });
            const codeFromUrl = qs('code');
            if (codeFromUrl) document.getElementById('code').value = codeFromUrl;
        }

        async function hasExistingSuperAdmin(){
            const db = window.FirebaseConfig.getDB();
            const q = await db.collection('users').where('isSuperAdmin','==',true).limit(1).get();
            return !q.empty;
        }

        async function promote(){
            hideAll();
            const code = document.getElementById('code').value.trim();
            if (code !== BOOTSTRAP_CODE){ show('msg-err','Falscher Bootstrap-Code.'); return; }

            const user = window.AuthAPI.getCurrentUser();
            const userData = window.AuthAPI.getUserData();
            if (!user){ show('msg-err','Bitte zuerst einloggen.'); return; }

            const email = (userData?.email || user.email || '').toLowerCase();
            const allowed = ALLOWED_EMAILS.map(e=>e.toLowerCase());

            const exists = await hasExistingSuperAdmin();
            if (!allowed.includes(email) && exists){
                show('msg-err','Es existiert bereits ein Super-Admin. Anfrage blockiert.');
                return;
            }

            try {
                const db = window.FirebaseConfig.getDB();
                await db.collection('users').doc(user.uid).set({
                    isSuperAdmin: true,
                    superAdminSince: window.FirebaseConfig.getServerTimestamp()
                }, { merge: true });
                show('msg-ok','‚úÖ Super-Admin Rechte vergeben. √ñffnen Sie jetzt das Admin-Dashboard.');
            } catch (e){
                console.error(e);
                show('msg-err','Fehler beim Setzen der Rechte: ' + (e?.message || 'Unbekannt'));
            }
        }

        document.addEventListener('DOMContentLoaded', init);
        document.getElementById('promote-btn').addEventListener('click', promote);
    </script>
</body>
</html>

