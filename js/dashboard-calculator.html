// Erg√§nzung f√ºr Ihre dashboard.html - Ersetzen Sie die loadUserStats() Funktion:

// Echte Benutzer-Statistiken laden (ersetze die bestehende Funktion)
async function loadUserStats() {
    try {
        if (!currentUser) return;
        
        console.log('üìà Lade echte Benutzer-Statistiken...');
        
        // Standardwerte setzen
        let battlesCount = 0;
        let winRate = 0;
        let totalDamage = 0;
        
        // Account-Alter berechnen
        const createdDate = userData.createdAt ? userData.createdAt.toDate() : new Date();
        const daysSinceCreation = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
        
        try {
            // Echte Statistiken aus Calculator-Data laden
            if (window.CalculatorAPI) {
                const stats = window.CalculatorAPI.getStats();
                
                battlesCount = stats.totalBattles || 0;
                winRate = stats.winRate || 0;
                totalDamage = stats.totalDamageDealt || 0;
                
                // Zus√§tzliche Raid-Statistiken (falls verf√ºgbar)
                const raidStats = await loadRaidStats();
                
                // Dashboard-Werte aktualisieren
                document.getElementById('battles-count').textContent = battlesCount;
                document.getElementById('raids-count').textContent = raidStats.totalRaids || 0;
                document.getElementById('win-rate').textContent = winRate + '%';
                document.getElementById('days-active').textContent = daysSinceCreation;
                
                console.log('‚úÖ Echte Statistiken geladen:', {
                    battles: battlesCount,
                    winRate: winRate + '%',
                    damage: totalDamage
                });
                
            } else {
                // Fallback falls Calculator-API nicht verf√ºgbar
                console.warn('‚ö†Ô∏è Calculator-API nicht verf√ºgbar - verwende Fallback-Werte');
                
                // Simulierte Werte basierend auf Account-Alter
                battlesCount = Math.floor(daysSinceCreation * 0.5) + Math.floor(Math.random() * 10);
                const raidsCount = Math.floor(daysSinceCreation * 0.2) + Math.floor(Math.random() * 5);
                winRate = Math.floor(60 + Math.random() * 30);
                
                document.getElementById('battles-count').textContent = battlesCount;
                document.getElementById('raids-count').textContent = raidsCount;
                document.getElementById('win-rate').textContent = winRate + '%';
                document.getElementById('days-active').textContent = daysSinceCreation;
            }
            
        } catch (apiError) {
            console.error('‚ùå Fehler beim Laden √ºber Calculator-API:', apiError);
            
            // Direkt aus Firestore laden als Fallback
            const db = window.FirebaseConfig.getDB();
            const statsDoc = await db.collection('userStats').doc(currentUser.uid).get();
            
            if (statsDoc.exists) {
                const firestoreStats = statsDoc.data();
                document.getElementById('battles-count').textContent = firestoreStats.battles || battlesCount;
                document.getElementById('raids-count').textContent = firestoreStats.raids || 0;
                document.getElementById('win-rate').textContent = (firestoreStats.winRate || winRate) + '%';
            }
        }
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Statistiken:', error);
        // Fallback-Werte setzen
        document.getElementById('battles-count').textContent = '0';
        document.getElementById('raids-count').textContent = '0';
        document.getElementById('win-rate').textContent = '0%';
        document.getElementById('days-active').textContent = '0';
    }
}

// Raid-Statistiken laden (f√ºr zuk√ºnftige Raid-Counter Integration)
async function loadRaidStats() {
    try {
        if (!currentUser) return { totalRaids: 0 };
        
        const db = window.FirebaseConfig.getDB();
        
        // Raids aus separater Collection laden (falls vorhanden)
        const raidsQuery = await db.collection('userRaids')
            .where('userId', '==', currentUser.uid)
            .get();
        
        return {
            totalRaids: raidsQuery.size || 0
        };
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Raid-Statistiken:', error);
        return { totalRaids: 0 };
    }
}

// Erweiterte Aktivit√§ten laden mit Calculator-Integration
async function loadRecentActivity() {
    const activityList = document.getElementById('activity-list');
    
    try {
        if (!currentUser) return;
        
        console.log('üìù Lade erweiterte Aktivit√§ten...');
        
        // Versuche echte Aktivit√§ten aus Firestore zu laden
        const db = window.FirebaseConfig.getDB();
        const activitiesQuery = await db.collection('userActivities')
            .where('userId', '==', currentUser.uid)
            .orderBy('timestamp', 'desc')
            .limit(8) // Mehr Aktivit√§ten f√ºr bessere √úbersicht
            .get();
        
        if (!activitiesQuery.empty) {
            let activitiesHtml = '';
            activitiesQuery.forEach(doc => {
                const activity = doc.data();
                const time = activity.timestamp.toDate().toLocaleString('de-DE');
                activitiesHtml += createActivityItem(activity.icon, activity.text, time);
            });
            activityList.innerHTML = activitiesHtml;
            
            console.log('‚úÖ Echte Aktivit√§ten geladen:', activitiesQuery.size);
            
        } else {
            // Fallback: Erweiterte Beispiel-Aktivit√§ten
            showEnhancedExampleActivities();
        }
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Aktivit√§ten:', error);
        showEnhancedExampleActivities();
    }
}

// Erweiterte Beispiel-Aktivit√§ten mit Calculator-Bezug
function showEnhancedExampleActivities() {
    const activityList = document.getElementById('activity-list');
    const now = new Date();
    
    const activities = [
        {
            icon: 'üéâ',
            text: 'Account erfolgreich erstellt',
            time: userData.createdAt ? userData.createdAt.toDate() : now
        },
        {
            icon: 'üîê',
            text: 'Erfolgreich angemeldet',
            time: new Date(now.getTime() - 5 * 60 * 1000)
        },
        {
            icon: 'üè†',
            text: 'Dashboard besucht',
            time: new Date(now.getTime() - 3 * 60 * 1000)
        },
        {
            icon: '‚öîÔ∏è',
            text: 'AS-Counter (Dashboard) verf√ºgbar',
            time: new Date(now.getTime() - 2 * 60 * 1000)
        },
        {
            icon: 'üìä',
            text: 'Kampfdaten-Tracking aktiviert',
            time: new Date(now.getTime() - 1 * 60 * 1000)
        }
    ];
    
    let activitiesHtml = '';
    activities.forEach(activity => {
        const timeStr = activity.time.toLocaleString('de-DE');
        activitiesHtml += createActivityItem(activity.icon, activity.text, timeStr);
    });
    
    activityList.innerHTML = activitiesHtml;
}

// Calculator-spezifische Aktivit√§ten verfolgen
function trackCalculatorActivity(activityType, details = {}) {
    if (!window.AuthAPI.addActivity) return;
    
    const activities = {
        'battle_calculated': {
            icon: '‚öîÔ∏è',
            text: `Kampf simuliert (${details.ships || 'unbekannt'} vs ${details.enemyShips || 'unbekannt'} Schiffe)`
        },
        'battle_won': {
            icon: 'üèÜ',
            text: `Kampf gewonnen! Schaden: ${details.damage || 0}`
        },
        'battle_lost': {
            icon: 'üíÄ',
            text: `Kampf verloren. Schaden erhalten: ${details.damageReceived || 0}`
        },
        'battle_draw': {
            icon: 'ü§ù',
            text: 'Kampf unentschieden'
        },
        'calculator_opened': {
            icon: 'üîß',
            text: 'AS-Counter (Dashboard) ge√∂ffnet'
        },
        'stats_viewed': {
            icon: 'üìà',
            text: 'Kampf-Statistiken angezeigt'
        }
    };
    
    const activity = activities[activityType];
    if (activity) {
        window.AuthAPI.addActivity(activity.icon, activity.text);
    }
}

// Dashboard-Navigation zu Calculator erweitern
function updateDashboardNavigation() {
    // AS-Counter Link im Dashboard aktualisieren
    const asCounterLinks = document.querySelectorAll('a[href="calculator.html"]');
    asCounterLinks.forEach(link => {
        // F√ºr eingeloggte User zum Dashboard-Calculator weiterleiten
        if (window.AuthAPI && window.AuthAPI.isLoggedIn()) {
            link.href = 'dashboard-calculator.html';
            link.title = 'AS-Counter (Dashboard) - Alle K√§mpfe werden gespeichert';
            
            // Icon und Text anpassen
            const icon = link.querySelector('.nav-icon, .action-icon');
            if (icon) {
                icon.textContent = '‚öîÔ∏èüíæ'; // Zeigt an, dass Daten gespeichert werden
            }
        }
    });
    
    // Raid-Counter Links f√ºr zuk√ºnftige Integration
    const raidCounterLinks = document.querySelectorAll('a[href="raid-counter.html"]');
    raidCounterLinks.forEach(link => {
        if (window.AuthAPI && window.AuthAPI.isLoggedIn()) {
            // link.href = 'dashboard-raid-counter.html'; // F√ºr zuk√ºnftige Implementation
            link.title = 'Raid-Counter - Bald mit Dashboard-Integration';
        }
    });
}

// Dashboard mit Calculator-Daten erweitern
async function enhanceDashboardWithCalculatorData() {
    try {
        if (!window.CalculatorAPI) {
            console.warn('‚ö†Ô∏è Calculator-API nicht verf√ºgbar');
            return;
        }
        
        // Detaillierte Kampf-Statistiken laden
        const stats = window.CalculatorAPI.getStats();
        const recentBattles = window.CalculatorAPI.getBattleHistory({ limit: 5 });
        const periodStats = window.CalculatorAPI.getPeriodStats(7); // Letzte 7 Tage
        
        // Zus√§tzliche Statistik-Karten erstellen
        createEnhancedStatsCards(stats, periodStats);
        
        // Letzte K√§mpfe in Aktivit√§ten einbinden
        integrateRecentBattlesIntoActivities(recentBattles);
        
        console.log('üìä Dashboard mit Calculator-Daten erweitert');
        
    } catch (error) {
        console.error('‚ùå Fehler beim Erweitern des Dashboards:', error);
    }
}

// Erweiterte Statistik-Karten erstellen
function createEnhancedStatsCards(stats, periodStats) {
    const statsGrid = document.querySelector('.stats-grid');
    if (!statsGrid) return;
    
    // Zus√§tzliche Stat-Card f√ºr Schaden
    const damageCard = document.createElement('div');
    damageCard.className = 'stat-card';
    damageCard.innerHTML = `
        <span class="stat-icon">üí•</span>
        <div class="stat-value">${stats.totalDamageDealt.toLocaleString()}</div>
        <div class="stat-label">Schaden verursacht</div>
    `;
    
    // Zus√§tzliche Stat-Card f√ºr diese Woche
    const weeklyCard = document.createElement('div');
    weeklyCard.className = 'stat-card';
    weeklyCard.innerHTML = `
        <span class="stat-icon">üìÖ</span>
        <div class="stat-value">${periodStats.totalBattles}</div>
        <div class="stat-label">K√§mpfe (7 Tage)</div>
    `;
    
    // Cards hinzuf√ºgen
    statsGrid.appendChild(damageCard);
    statsGrid.appendChild(weeklyCard);
}

// Letzte K√§mpfe in Aktivit√§ten integrieren
function integrateRecentBattlesIntoActivities(recentBattles) {
    if (!recentBattles || recentBattles.length === 0) return;
    
    const activityList = document.getElementById('activity-list');
    if (!activityList) return;
    
    // Vorhandene Aktivit√§ten holen
    const existingActivities = activityList.innerHTML;
    
    // Kampf-Aktivit√§ten erstellen
    let battleActivitiesHtml = '';
    recentBattles.slice(0, 3).forEach(battle => { // Nur die letzten 3 K√§mpfe
        const battleDate = battle.timestamp?.toDate ? battle.timestamp.toDate() : new Date(battle.timestamp);
        const resultEmoji = battle.result === 'win' ? 'üèÜ' : battle.result === 'loss' ? 'üíÄ' : 'ü§ù';
        const resultText = battle.result === 'win' ? 'Kampf gewonnen' : battle.result === 'loss' ? 'Kampf verloren' : 'Kampf unentschieden';
        
        battleActivitiesHtml += createActivityItem(
            resultEmoji, 
            `${resultText} (${battle.attackerShips} vs ${battle.defenderShips} Schiffe)`,
            battleDate.toLocaleString('de-DE')
        );
    });
    
    // Kampf-Aktivit√§ten an den Anfang setzen
    activityList.innerHTML = battleActivitiesHtml + existingActivities;
}

// Calculator-Integration beim Dashboard-Load
async function initializeCalculatorIntegration() {
    try {
        // Warten bis Calculator-Data-Manager bereit ist
        if (window.CalculatorAPI) {
            await new Promise(resolve => {
                const checkReady = setInterval(() => {
                    if (window.CalculatorAPI.isLoggedIn()) {
                        clearInterval(checkReady);
                        resolve();
                    }
                }, 100);
                
                // Timeout nach 5 Sekunden
                setTimeout(() => {
                    clearInterval(checkReady);
                    resolve();
                }, 5000);
            });
            
            // Dashboard erweitern
            await enhanceDashboardWithCalculatorData();
            
            // Navigation aktualisieren
            updateDashboardNavigation();
        }
        
        console.log('‚öîÔ∏è Calculator-Integration abgeschlossen');
        
    } catch (error) {
        console.error('‚ùå Fehler bei Calculator-Integration:', error);
    }
}

// Event-Listener f√ºr Calculator-Data-Updates
function setupCalculatorDataListener() {
    // Lausche auf Calculator-Updates (custom events)
    document.addEventListener('calculatorDataUpdated', async (event) => {
        console.log('üìä Calculator-Daten aktualisiert - Dashboard wird neu geladen');
        
        try {
            // Statistiken neu laden
            await loadUserStats();
            
            // Dashboard erweitern
            await enhanceDashboardWithCalculatorData();
            
        } catch (error) {
            console.error('‚ùå Fehler beim Aktualisieren nach Calculator-Update:', error);
        }
    });
}

// Export-Funktionen f√ºr Dashboard-Calculator-Integration
function exportDashboardCalculatorIntegration() {
    return {
        // Calculator-Aktivit√§t verfolgen
        trackActivity: trackCalculatorActivity,
        
        // Dashboard nach Calculator-Update aktualisieren
        refreshDashboard: async () => {
            await loadUserStats();
            await loadRecentActivity();
            await enhanceDashboardWithCalculatorData();
        },
        
        // Statistiken f√ºr Calculator bereitstellen
        getCalculatorStats: () => {
            if (window.CalculatorAPI) {
                return window.CalculatorAPI.getStats();
            }
            return null;
        },
        
        // Navigation zu Calculator
        openCalculator: () => {
            if (window.AuthAPI && window.AuthAPI.isLoggedIn()) {
                window.location.href = 'dashboard-calculator.html';
            } else {
                window.location.href = 'calculator.html';
            }
        }
    };
}

// Integration beim Dashboard-Load starten
document.addEventListener('DOMContentLoaded', async function() {
    // Calculator-Integration nach kurzem Delay starten
    setTimeout(async () => {
        await initializeCalculatorIntegration();
        setupCalculatorDataListener();
    }, 2000);
});

// Globale Integration-API bereitstellen
window.dashboardCalculatorIntegration = exportDashboardCalculatorIntegration();

console.log('üìä Dashboard-Calculator-Integration geladen');
console.log('üîó Integration-API verf√ºgbar: window.dashboardCalculatorIntegration');
