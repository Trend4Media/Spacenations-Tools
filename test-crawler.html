<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spy Crawler Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0056b3; }
        .button.secondary { background: #6c757d; }
        .result { margin: 15px 0; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: #e9ecef; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #007bff; }
        .method-test { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 10px 0; }
        .method-result { padding: 10px; border-radius: 4px; text-align: center; font-weight: bold; }
        .method-success { background: #d4edda; color: #155724; }
        .method-failed { background: #f8d7da; color: #721c24; }
        .method-pending { background: #fff3cd; color: #856404; }
        .url-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
        .url-item { padding: 5px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üï∑Ô∏è Spy Crawler Test</h1>
            <p>Teste das Crawling-System f√ºr Spionageberichte von spacenations.eu</p>
        </div>

        <div class="card">
            <h3>Einzelner URL-Test</h3>
            <input type="url" id="test-url" class="test-input" placeholder="https://beta1.game.spacenations.eu/spy-report/..." value="https://beta1.game.spacenations.eu/spy-report/9uxy7W61audGIuswMNby">
            <div>
                <button onclick="testSingleUrl()" class="button">üîç URL Crawlen</button>
                <button onclick="testUrlValidation()" class="button secondary">‚úÖ URL Validieren</button>
                <button onclick="testAlternativeUrls()" class="button secondary">üîÑ Alternative URLs</button>
                <button onclick="checkUrlAvailability()" class="button secondary">üì° Verf√ºgbarkeit pr√ºfen</button>
            </div>
            <div id="single-result"></div>
        </div>

        <div class="card">
            <h3>Crawling-Methoden Test</h3>
            <p>Teste verschiedene Crawling-Methoden f√ºr die eingegebene URL:</p>
            <div class="method-test">
                <div class="method-result method-pending" id="direct-method">Direkter Fetch</div>
                <div class="method-result method-pending" id="proxy-method">CORS Proxy</div>
                <div class="method-result method-pending" id="fallback-method">Fallback</div>
            </div>
            <button onclick="testAllMethods()" class="button">üß™ Alle Methoden testen</button>
            <div id="methods-result"></div>
        </div>

        <div class="card">
            <h3>Batch-Test</h3>
            <p>Teste mehrere URLs gleichzeitig:</p>
            <textarea id="batch-urls" class="test-input" rows="5" placeholder="Eine URL pro Zeile...">https://beta1.game.spacenations.eu/spy-report/9uxy7W61audGIuswMNby
https://beta1.game.spacenations.eu/spy-report/example1
https://beta1.game.spacenations.eu/spy-report/example2</textarea>
            <button onclick="runBatchTest()" class="button">üìä Batch-Test starten</button>
            <div id="batch-result"></div>
        </div>

        <div class="card">
            <h3>Crawler-Statistiken</h3>
            <div class="stats" id="crawler-stats">
                <div class="stat-card">
                    <div class="stat-number" id="success-rate">-</div>
                    <div>Erfolgsrate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avg-time">-</div>
                    <div>√ò Zeit (ms)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-tests">-</div>
                    <div>Tests</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Debug-Log</h3>
            <button onclick="clearLog()" class="button secondary">üóëÔ∏è Log l√∂schen</button>
            <div id="debug-log" class="log"></div>
        </div>
    </div>

    <script src="js/spy-crawler.js"></script>
    <script>
        let testStats = {
            totalTests: 0,
            successfulTests: 0,
            totalTime: 0
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                info: '#0c5460',
                success: '#155724',
                error: '#721c24',
                warning: '#856404'
            };
            
            logDiv.innerHTML += `<div style="color: ${colorMap[type]};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }

        function updateStats() {
            const successRate = testStats.totalTests > 0 ? 
                Math.round((testStats.successfulTests / testStats.totalTests) * 100) : 0;
            const avgTime = testStats.totalTests > 0 ? 
                Math.round(testStats.totalTime / testStats.totalTests) : 0;

            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('avg-time').textContent = avgTime;
            document.getElementById('total-tests').textContent = testStats.totalTests;
        }

        async function testSingleUrl() {
            const url = document.getElementById('test-url').value.trim();
            const resultDiv = document.getElementById('single-result');
            
            if (!url) {
                resultDiv.innerHTML = '<div class="result error">Bitte eine URL eingeben</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="result info">üîç Crawling l√§uft...</div>';
            log(`Starte Crawling f√ºr: ${url}`);

            const startTime = performance.now();
            testStats.totalTests++;

            try {
                const result = await window.SpyCrawler.crawlWithAlternatives(url);
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);

                testStats.successfulTests++;
                testStats.totalTime += duration;

                const htmlLength = result.html.length;
                const usedUrl = result.usedUrl !== url ? ` (Alternative URL verwendet: ${result.usedUrl})` : '';
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        ‚úÖ Crawling erfolgreich!<br>
                        üìä HTML-L√§nge: ${htmlLength.toLocaleString()} Zeichen<br>
                        ‚è±Ô∏è Dauer: ${duration}ms${usedUrl}
                    </div>
                `;

                log(`Crawling erfolgreich: ${htmlLength} Zeichen in ${duration}ms`, 'success');
            } catch (error) {
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                testStats.totalTime += duration;

                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Crawling fehlgeschlagen<br>
                        Fehler: ${error.message}<br>
                        ‚è±Ô∏è Dauer: ${duration}ms
                    </div>
                `;

                log(`Crawling fehlgeschlagen: ${error.message}`, 'error');
            }

            updateStats();
        }

        async function testUrlValidation() {
            const url = document.getElementById('test-url').value.trim();
            const resultDiv = document.getElementById('single-result');
            
            if (!url) {
                resultDiv.innerHTML = '<div class="result error">Bitte eine URL eingeben</div>';
                return;
            }

            const isValid = window.SpyCrawler._isValidSpyReportUrl(url);
            const reportId = window.SpyCrawler.extractReportId(url);

            resultDiv.innerHTML = `
                <div class="result ${isValid ? 'success' : 'error'}">
                    ${isValid ? '‚úÖ' : '‚ùå'} URL-Validierung: ${isValid ? 'G√ºltig' : 'Ung√ºltig'}<br>
                    üìã Bericht-ID: ${reportId || 'Nicht gefunden'}
                </div>
            `;

            log(`URL-Validierung: ${isValid ? 'G√ºltig' : 'Ung√ºltig'}, ID: ${reportId}`, isValid ? 'success' : 'error');
        }

        async function testAlternativeUrls() {
            const url = document.getElementById('test-url').value.trim();
            const resultDiv = document.getElementById('single-result');
            
            if (!url) {
                resultDiv.innerHTML = '<div class="result error">Bitte eine URL eingeben</div>';
                return;
            }

            const alternatives = window.SpyCrawler.generateAlternativeUrls(url);
            
            let html = `<div class="result info">
                üîÑ ${alternatives.length} alternative URLs generiert:<br>
                <div class="url-list">`;
            
            alternatives.forEach(altUrl => {
                html += `<div class="url-item">${altUrl}</div>`;
            });
            
            html += '</div></div>';
            resultDiv.innerHTML = html;

            log(`${alternatives.length} alternative URLs generiert`, 'info');
        }

        async function checkUrlAvailability() {
            const url = document.getElementById('test-url').value.trim();
            const resultDiv = document.getElementById('single-result');
            
            if (!url) {
                resultDiv.innerHTML = '<div class="result error">Bitte eine URL eingeben</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="result info">üì° Pr√ºfe Verf√ºgbarkeit...</div>';

            try {
                const isAvailable = await window.SpyCrawler.checkUrlAvailability(url);
                
                resultDiv.innerHTML = `
                    <div class="result ${isAvailable ? 'success' : 'warning'}">
                        ${isAvailable ? '‚úÖ URL erreichbar' : '‚ö†Ô∏è URL nicht erreichbar (m√∂glicherweise CORS-blockiert)'}
                    </div>
                `;

                log(`URL-Verf√ºgbarkeit: ${isAvailable ? 'Erreichbar' : 'Nicht erreichbar'}`, isAvailable ? 'success' : 'warning');
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Fehler bei Verf√ºgbarkeitspr√ºfung: ${error.message}
                    </div>
                `;

                log(`Verf√ºgbarkeitspr√ºfung fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        async function testAllMethods() {
            const url = document.getElementById('test-url').value.trim();
            
            if (!url) {
                alert('Bitte eine URL eingeben');
                return;
            }

            // Reset method displays
            ['direct-method', 'proxy-method', 'fallback-method'].forEach(id => {
                const element = document.getElementById(id);
                element.className = 'method-result method-pending';
                element.textContent = element.textContent.split(' - ')[0] + ' - Testing...';
            });

            const crawler = window.SpyCrawler;
            const methods = [
                { name: 'direct', func: () => crawler._directFetch(url), id: 'direct-method' },
                { name: 'proxy', func: () => crawler._corsProxyFetch(url), id: 'proxy-method' },
                { name: 'fallback', func: () => crawler._fallbackFetch(url), id: 'fallback-method' }
            ];

            for (const method of methods) {
                try {
                    log(`Teste ${method.name} Methode...`);
                    const startTime = performance.now();
                    
                    const result = await method.func();
                    const duration = Math.round(performance.now() - startTime);
                    
                    const element = document.getElementById(method.id);
                    element.className = 'method-result method-success';
                    element.textContent = `${element.textContent.split(' - ')[0]} - ‚úÖ ${duration}ms`;
                    
                    log(`${method.name} erfolgreich: ${result.length} Zeichen in ${duration}ms`, 'success');
                } catch (error) {
                    const duration = Math.round(performance.now() - startTime);
                    
                    const element = document.getElementById(method.id);
                    element.className = 'method-result method-failed';
                    element.textContent = `${element.textContent.split(' - ')[0]} - ‚ùå ${error.message.substring(0, 20)}...`;
                    
                    log(`${method.name} fehlgeschlagen: ${error.message}`, 'error');
                }
            }
        }

        async function runBatchTest() {
            const urls = document.getElementById('batch-urls').value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            if (urls.length === 0) {
                document.getElementById('batch-result').innerHTML = '<div class="result error">Keine URLs eingegeben</div>';
                return;
            }

            const resultDiv = document.getElementById('batch-result');
            resultDiv.innerHTML = `<div class="result info">üîÑ Teste ${urls.length} URLs...</div>`;

            log(`Starte Batch-Test mit ${urls.length} URLs`);

            try {
                const results = await window.SpyCrawler.analyzeCrawlingSuccess(urls);
                
                testStats.totalTests += results.total;
                testStats.successfulTests += results.successful;

                let html = `
                    <div class="result ${results.successRate > 50 ? 'success' : 'warning'}">
                        üìä Batch-Test Ergebnisse:<br>
                        ‚úÖ Erfolgreich: ${results.successful}/${results.total} (${results.successRate.toFixed(1)}%)<br>
                        ‚ùå Fehlgeschlagen: ${results.failed}
                    </div>
                `;

                if (results.errors.length > 0) {
                    html += '<div class="result error">Fehler:<div class="url-list">';
                    results.errors.forEach(error => {
                        html += `<div class="url-item">${error.url}: ${error.error}</div>`;
                    });
                    html += '</div></div>';
                }

                resultDiv.innerHTML = html;
                
                log(`Batch-Test abgeschlossen: ${results.successRate.toFixed(1)}% Erfolgsrate`, 
                    results.successRate > 50 ? 'success' : 'warning');
                
                updateStats();
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Batch-Test fehlgeschlagen: ${error.message}</div>`;
                log(`Batch-Test fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        // Initial stats update
        updateStats();
        log('Crawler-Test-Interface geladen', 'success');
    </script>
</body>
</html>