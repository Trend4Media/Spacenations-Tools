<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth Debug - Spacenations Tools</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0A0A0A;
            color: #00FF88;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #111111;
            border: 2px solid #00FF88;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #00FF88;
            color: #0A0A0A;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .test-button:hover {
            background: #44FF99;
        }
        .result {
            background: #1A1A1A;
            border: 1px solid #2A2A2A;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-color: #00FF88; color: #00FF88; }
        .error { border-color: #FF3B30; color: #FF3B30; }
        .warning { border-color: #FFA500; color: #FFA500; }
        .info { border-color: #00BFFF; color: #00BFFF; }
        input {
            background: #1A1A1A;
            border: 1px solid #2A2A2A;
            color: #00FF88;
            padding: 8px;
            border-radius: 4px;
            width: 200px;
            margin: 5px;
        }
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .user-card {
            background: #1A1A1A;
            border: 1px solid #2A2A2A;
            border-radius: 4px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firebase Auth Debug Tool</h1>
        <p>Untersucht Firebase Authentication und Benutzerregistrierung.</p>
        
        <div class="test-section">
            <h2>1. Firebase Auth Status</h2>
            <button class="test-button" onclick="checkAuthStatus()">Auth Status pr√ºfen</button>
            <div id="auth-status" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>2. E-Mail-Verf√ºgbarkeit pr√ºfen</h2>
            <input type="email" id="test-email" placeholder="E-Mail eingeben" value="t.o@trend4media.de">
            <button class="test-button" onclick="checkEmailAvailability()">E-Mail pr√ºfen</button>
            <div id="email-check" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>3. Benutzer in Firestore suchen</h2>
            <input type="text" id="search-username" placeholder="Benutzername" value="Daikin">
            <input type="email" id="search-email" placeholder="E-Mail" value="t.o@trend4media.de">
            <button class="test-button" onclick="searchUsersInFirestore()">In Firestore suchen</button>
            <div id="firestore-search" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>4. Alle Benutzer in Firestore anzeigen</h2>
            <button class="test-button" onclick="listAllUsers()">Alle Benutzer laden</button>
            <div id="all-users" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>5. Test-Benutzer erstellen</h2>
            <input type="email" id="create-email" placeholder="E-Mail" value="test@example.com">
            <input type="password" id="create-password" placeholder="Passwort" value="test123456">
            <input type="text" id="create-username" placeholder="Benutzername" value="TestUser">
            <button class="test-button" onclick="createTestUser()">Test-Benutzer erstellen</button>
            <div id="create-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>6. Login mit Test-Benutzer</h2>
            <input type="email" id="login-email" placeholder="E-Mail" value="test@example.com">
            <input type="password" id="login-password" placeholder="Passwort" value="test123456">
            <button class="test-button" onclick="testLogin()">Login testen</button>
            <div id="login-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>7. Firebase-Konfiguration pr√ºfen</h2>
            <button class="test-button" onclick="checkFirebaseConfig()">Konfiguration pr√ºfen</button>
            <div id="config-result" class="result"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Scripts -->
    <script src="js/logger.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-manager.js"></script>

    <script>
        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        async function checkAuthStatus() {
            logResult('auth-status', 'Pr√ºfe Firebase Auth Status...', 'warning');
            
            try {
                if (!window.firebase || !window.firebase.auth) {
                    throw new Error('Firebase Auth nicht verf√ºgbar');
                }
                
                const auth = window.firebase.auth();
                const currentUser = auth.currentUser;
                
                let status = `Firebase Auth Status:\n`;
                status += `Auth verf√ºgbar: ${auth ? 'Ja' : 'Nein'}\n`;
                status += `Aktueller User: ${currentUser ? currentUser.email : 'Keiner'}\n`;
                status += `Auth Domain: ${auth.app.options.authDomain}\n`;
                status += `Project ID: ${auth.app.options.projectId}\n`;
                
                // Pr√ºfe ob Auth bereit ist
                await new Promise((resolve) => {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        status += `Auth State Listener: Funktioniert\n`;
                        status += `User State: ${user ? 'Eingeloggt' : 'Ausgeloggt'}\n`;
                        resolve();
                    });
                    
                    setTimeout(() => {
                        unsubscribe();
                        status += `Auth State Listener: Timeout\n`;
                        resolve();
                    }, 3000);
                });
                
                logResult('auth-status', status, 'success');
                
            } catch (error) {
                logResult('auth-status', `‚ùå Auth Status Fehler:\n${error.message}`, 'error');
            }
        }

        async function checkEmailAvailability() {
            const email = document.getElementById('test-email').value;
            logResult('email-check', `Pr√ºfe E-Mail: ${email}...`, 'warning');
            
            try {
                if (!window.firebase || !window.firebase.auth) {
                    throw new Error('Firebase Auth nicht verf√ºgbar');
                }
                
                const auth = window.firebase.auth();
                const methods = await auth.fetchSignInMethodsForEmail(email);
                
                if (methods.length === 0) {
                    logResult('email-check', 
                        `‚ùå E-Mail nicht in Firebase Auth registriert: ${email}\n\n` +
                        `Das bedeutet:\n` +
                        `- Der Benutzer existiert nicht in Firebase Authentication\n` +
                        `- Er muss sich zuerst registrieren\n` +
                        `- Oder die E-Mail-Adresse ist falsch\n\n` +
                        `L√ñSUNG: Benutzer registrieren oder korrekte E-Mail verwenden`, 
                        'error'
                    );
                } else {
                    logResult('email-check', 
                        `‚úÖ E-Mail in Firebase Auth gefunden!\n` +
                        `Email: ${email}\n` +
                        `Verf√ºgbare Methoden: ${methods.join(', ')}\n` +
                        `Status: Registriert und bereit f√ºr Login`, 
                        'success'
                    );
                }
                
            } catch (error) {
                logResult('email-check', `‚ùå E-Mail-Pr√ºfung fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function searchUsersInFirestore() {
            const username = document.getElementById('search-username').value;
            const email = document.getElementById('search-email').value;
            logResult('firestore-search', `Suche in Firestore...`, 'warning');
            
            try {
                if (!window.firebase || !window.firebase.firestore) {
                    throw new Error('Firebase Firestore nicht verf√ºgbar');
                }
                
                const db = window.firebase.firestore();
                let results = `Firestore-Suche Ergebnisse:\n\n`;
                
                // Suche nach Benutzername
                try {
                    const usernameQuery = await db.collection('users')
                        .where('username', '==', username)
                        .limit(5)
                        .get();
                    
                    results += `Benutzername "${username}":\n`;
                    if (usernameQuery.empty) {
                        results += `  ‚ùå Nicht gefunden\n`;
                    } else {
                        usernameQuery.forEach(doc => {
                            const data = doc.data();
                            results += `  ‚úÖ Gefunden: ${data.username} (${data.email})\n`;
                        });
                    }
                } catch (error) {
                    results += `  ‚ùå Fehler: ${error.message}\n`;
                }
                
                results += `\n`;
                
                // Suche nach E-Mail
                try {
                    const emailQuery = await db.collection('users')
                        .where('email', '==', email)
                        .limit(5)
                        .get();
                    
                    results += `E-Mail "${email}":\n`;
                    if (emailQuery.empty) {
                        results += `  ‚ùå Nicht gefunden\n`;
                    } else {
                        emailQuery.forEach(doc => {
                            const data = doc.data();
                            results += `  ‚úÖ Gefunden: ${data.username} (${data.email})\n`;
                        });
                    }
                } catch (error) {
                    results += `  ‚ùå Fehler: ${error.message}\n`;
                }
                
                logResult('firestore-search', results, 'info');
                
            } catch (error) {
                logResult('firestore-search', `‚ùå Firestore-Suche fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function listAllUsers() {
            logResult('all-users', 'Lade alle Benutzer aus Firestore...', 'warning');
            
            try {
                if (!window.firebase || !window.firebase.firestore) {
                    throw new Error('Firebase Firestore nicht verf√ºgbar');
                }
                
                const db = window.firebase.firestore();
                const usersQuery = await db.collection('users').limit(20).get();
                
                if (usersQuery.empty) {
                    logResult('all-users', 
                        `‚ùå Keine Benutzer in Firestore gefunden!\n\n` +
                        `Das bedeutet:\n` +
                        `- Die 'users' Collection ist leer\n` +
                        `- Benutzer wurden noch nicht erstellt\n` +
                        `- Oder es gibt ein Berechtigungsproblem\n\n` +
                        `L√ñSUNG: Benutzer registrieren oder Firestore-Berechtigungen pr√ºfen`, 
                        'error'
                    );
                } else {
                    let results = `Gefundene Benutzer (${usersQuery.size}):\n\n`;
                    
                    usersQuery.forEach(doc => {
                        const data = doc.data();
                        results += `üìß ${data.email || 'Keine E-Mail'}\n`;
                        results += `üë§ ${data.username || 'Kein Username'}\n`;
                        results += `üÜî ${doc.id}\n`;
                        results += `üîê SystemRole: ${data.systemRole || 'Nicht gesetzt'}\n`;
                        results += `‚úÖ Aktiv: ${data.isActive ? 'Ja' : 'Nein'}\n`;
                        results += `---\n`;
                    });
                    
                    logResult('all-users', results, 'success');
                }
                
            } catch (error) {
                logResult('all-users', `‚ùå Benutzer laden fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function createTestUser() {
            const email = document.getElementById('create-email').value;
            const password = document.getElementById('create-password').value;
            const username = document.getElementById('create-username').value;
            
            logResult('create-result', `Erstelle Test-Benutzer: ${email}...`, 'warning');
            
            try {
                if (!window.firebase || !window.firebase.auth) {
                    throw new Error('Firebase Auth nicht verf√ºgbar');
                }
                
                const auth = window.firebase.auth();
                
                // 1. Firebase Auth User erstellen
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                let result = `‚úÖ Firebase Auth User erstellt!\n`;
                result += `UID: ${user.uid}\n`;
                result += `Email: ${user.email}\n\n`;
                
                // 2. Firestore User Document erstellen
                if (window.firebase.firestore) {
                    const db = window.firebase.firestore();
                    const userDoc = {
                        username: username,
                        email: email,
                        systemRole: 'user',
                        isActive: true,
                        createdAt: new Date(),
                        loginCount: 0,
                        permissions: {
                            dashboard_access: true,
                            profile_edit: true,
                            admin_dashboard: false,
                            user_management: false,
                            alliance_management: false,
                            system_settings: false
                        }
                    };
                    
                    await db.collection('users').doc(user.uid).set(userDoc);
                    result += `‚úÖ Firestore User Document erstellt!\n`;
                    result += `Username: ${username}\n`;
                    result += `SystemRole: user\n`;
                }
                
                result += `\nüéâ Test-Benutzer erfolgreich erstellt!`;
                logResult('create-result', result, 'success');
                
            } catch (error) {
                logResult('create-result', `‚ùå Test-Benutzer erstellen fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            logResult('login-result', `Teste Login: ${email}...`, 'warning');
            
            try {
                if (!window.firebase || !window.firebase.auth) {
                    throw new Error('Firebase Auth nicht verf√ºgbar');
                }
                
                const auth = window.firebase.auth();
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                logResult('login-result', 
                    `‚úÖ Login erfolgreich!\n` +
                    `Email: ${user.email}\n` +
                    `UID: ${user.uid}\n` +
                    `Email Verified: ${user.emailVerified}\n` +
                    `Creation Time: ${user.metadata.creationTime}\n` +
                    `Last Sign In: ${user.metadata.lastSignInTime}`, 
                    'success'
                );
                
                // Logout nach Test
                await auth.signOut();
                
            } catch (error) {
                logResult('login-result', `‚ùå Login fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function checkFirebaseConfig() {
            logResult('config-result', 'Pr√ºfe Firebase-Konfiguration...', 'warning');
            
            try {
                if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                    throw new Error('Firebase nicht initialisiert');
                }
                
                const app = window.firebase.apps[0];
                const config = app.options;
                
                let result = `Firebase-Konfiguration:\n\n`;
                result += `Project ID: ${config.projectId}\n`;
                result += `Auth Domain: ${config.authDomain}\n`;
                result += `Database URL: ${config.databaseURL || 'Nicht gesetzt'}\n`;
                result += `Storage Bucket: ${config.storageBucket || 'Nicht gesetzt'}\n`;
                result += `API Key: ${config.apiKey ? 'Gesetzt' : 'Nicht gesetzt'}\n`;
                result += `App ID: ${config.appId}\n`;
                result += `Measurement ID: ${config.measurementId || 'Nicht gesetzt'}\n\n`;
                
                // Pr√ºfe ob Auth aktiviert ist
                try {
                    const auth = window.firebase.auth();
                    result += `Auth Status: ‚úÖ Aktiviert\n`;
                } catch (error) {
                    result += `Auth Status: ‚ùå Fehler - ${error.message}\n`;
                }
                
                // Pr√ºfe ob Firestore aktiviert ist
                try {
                    const db = window.firebase.firestore();
                    result += `Firestore Status: ‚úÖ Aktiviert\n`;
                } catch (error) {
                    result += `Firestore Status: ‚ùå Fehler - ${error.message}\n`;
                }
                
                logResult('config-result', result, 'success');
                
            } catch (error) {
                logResult('config-result', `‚ùå Konfiguration pr√ºfen fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        // Automatisch beim Laden starten
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Firebase Auth Debug Tool geladen');
            checkAuthStatus();
        });
    </script>
</body>
</html>