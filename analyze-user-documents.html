<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Documents Analyzer - Spacenations Tools</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0A0A0A;
            color: #FFFFFF;
            padding: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1A1A1A;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00FF88;
        }
        
        h1 {
            color: #00FF88;
            margin-bottom: 30px;
        }
        
        .btn {
            background: #00FF88;
            color: #000000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn:hover {
            background: #44FF99;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.danger {
            background: #F44336;
            color: #FFFFFF;
        }
        
        .btn.danger:hover {
            background: #E57373;
        }
        
        .btn.warning {
            background: #FF9800;
            color: #000000;
        }
        
        .btn.warning:hover {
            background: #FFB74D;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: left;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid #F44336;
        }
        
        .info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
            border: 1px solid #2196F3;
        }
        
        .warning {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
            border: 1px solid #FF9800;
        }
        
        .data-table {
            background: #2A2A2A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .user-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00FF88;
        }
        
        .user-item h4 {
            margin: 0 0 10px 0;
            color: #00FF88;
        }
        
        .user-item p {
            margin: 5px 0;
            color: #CCC;
            font-family: monospace;
            font-size: 12px;
        }
        
        .user-item .field {
            display: inline-block;
            background: #444;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .user-item .field.has-value {
            background: #4CAF50;
            color: #000;
        }
        
        .user-item .field.missing {
            background: #F44336;
            color: #FFF;
        }
        
        .analysis-summary {
            background: #2A2A2A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .analysis-summary h3 {
            color: #00FF88;
            margin-bottom: 15px;
        }
        
        .analysis-summary ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .analysis-summary li {
            margin: 5px 0;
            color: #CCC;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #00FF88;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç User Documents Analyzer</h1>
        <p>Analysiert User-Dokumente in der Firestore-Datenbank</p>
        
        <div class="analysis-summary">
            <h3>üîç Was wird analysiert:</h3>
            <ul>
                <li><strong>Dokument-IDs:</strong> Wie User-Dokumente identifiziert werden</li>
                <li><strong>Feld-Struktur:</strong> Welche Felder vorhanden sind</li>
                <li><strong>Alliance-Daten:</strong> Alliance-Zuordnungen und Rollen</li>
                <li><strong>Konsistenz-Probleme:</strong> Fehlende oder falsche Daten</li>
                <li><strong>Dokument-Typen:</strong> Username vs UID als Dokument-ID</li>
            </ul>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progress-text">Bereite Analyse vor...</p>
        </div>
        
        <div id="data-table" class="data-table" style="display: none;">
            <h3>üë• User-Dokumente Analyse:</h3>
            <div id="user-items"></div>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="btn" onclick="analyzeUserDocuments()">üîç User-Dokumente analysieren</button>
            <button class="btn warning" onclick="fixUserDocuments()" id="fix-btn" style="display: none;">üîß User-Dokumente korrigieren</button>
            <button class="btn danger" onclick="createMissingUserDocuments()" id="create-btn" style="display: none;">‚ûï Fehlende User-Dokumente erstellen</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: 'AIzaSyDr4-ap_EubUn0UdP7hkEpS2jkzLIVgvyc',
            authDomain: 'spacenations-tools.firebaseapp.com',
            projectId: 'spacenations-tools',
            storageBucket: 'spacenations-tools.firebasestorage.app',
            messagingSenderId: '651338201276',
            appId: '1:651338201276:web:89e7d9c19dbd2611d3f8b9',
            measurementId: 'G-SKWJWH2ERX'
        };
        
        // Firebase initialisieren
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();
        
        let analysisData = {
            users: [],
            issues: [],
            recommendations: []
        };
        
        async function analyzeUserDocuments() {
            try {
                showStatus('Analysiere User-Dokumente...', 'info');
                showProgress(true);
                updateProgress(10, 'Lade alle User-Dokumente...');
                
                // Lade alle User-Dokumente
                const usersSnapshot = await db.collection('users').get();
                analysisData.users = usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    data: doc.data(),
                    exists: true
                }));
                
                updateProgress(50, 'Analysiere Dokument-Struktur...');
                
                // Analysiere die Struktur
                analysisData.issues = [];
                analysisData.recommendations = [];
                
                for (const user of analysisData.users) {
                    const issues = analyzeUserDocument(user);
                    if (issues.length > 0) {
                        analysisData.issues.push({
                            userId: user.id,
                            username: user.data.username || 'Unbekannt',
                            issues: issues
                        });
                    }
                }
                
                updateProgress(100, 'Analyse abgeschlossen');
                
                displayAnalysisResults();
                showStatus(`Analyse abgeschlossen: ${analysisData.users.length} User-Dokumente, ${analysisData.issues.length} mit Problemen`, 'success');
                
                // Zeige Fix-Buttons
                if (analysisData.issues.length > 0) {
                    document.getElementById('fix-btn').style.display = 'inline-block';
                }
                document.getElementById('create-btn').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Fehler bei der Analyse:', error);
                showStatus('Fehler bei der Analyse: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        function analyzeUserDocument(user) {
            const issues = [];
            const data = user.data;
            
            // Pr√ºfe wichtige Felder
            if (!data.username) {
                issues.push('Fehlender Benutzername');
            }
            
            if (!data.email) {
                issues.push('Fehlende E-Mail');
            }
            
            if (!data.systemRole) {
                issues.push('Fehlende System-Rolle');
            }
            
            if (data.alliance && !data.allianceTag) {
                issues.push('Alliance ohne Tag');
            }
            
            if (data.allianceRole && !data.alliance) {
                issues.push('Alliance-Rolle ohne Alliance');
            }
            
            // Pr√ºfe ob Dokument-ID mit Username √ºbereinstimmt
            if (data.username && data.username !== user.id) {
                issues.push(`Dokument-ID (${user.id}) stimmt nicht mit Username (${data.username}) √ºberein`);
            }
            
            return issues;
        }
        
        function displayAnalysisResults() {
            const dataTable = document.getElementById('data-table');
            const userItems = document.getElementById('user-items');
            
            dataTable.style.display = 'block';
            
            let html = '';
            
            // User mit Problemen
            if (analysisData.issues.length > 0) {
                html += '<h4 style="color: #FF9800;">‚ö†Ô∏è User mit Problemen:</h4>';
                analysisData.issues.forEach(user => {
                    html += createUserItem(user, 'problem');
                });
            }
            
            // Alle User
            html += '<h4 style="color: #00FF88;">üë• Alle User-Dokumente:</h4>';
            analysisData.users.forEach(user => {
                const hasIssues = analysisData.issues.some(issue => issue.userId === user.id);
                html += createUserItem({
                    userId: user.id,
                    username: user.data.username || 'Unbekannt',
                    issues: hasIssues ? ['Siehe oben'] : []
                }, hasIssues ? 'problem' : 'normal');
            });
            
            userItems.innerHTML = html;
        }
        
        function createUserItem(user, type) {
            const isProblem = type === 'problem';
            
            return `
                <div class="user-item ${isProblem ? 'problem' : ''}">
                    <h4>${user.username} (ID: ${user.userId})</h4>
                    <p><strong>Dokument-ID:</strong> ${user.userId}</p>
                    <p><strong>Probleme:</strong> ${user.issues.length > 0 ? user.issues.join(', ') : 'Keine'}</p>
                    <div style="margin-top: 10px;">
                        <span class="field ${user.username ? 'has-value' : 'missing'}">Username</span>
                        <span class="field ${user.email ? 'has-value' : 'missing'}">Email</span>
                        <span class="field ${user.systemRole ? 'has-value' : 'missing'}">SystemRole</span>
                        <span class="field ${user.alliance ? 'has-value' : 'missing'}">Alliance</span>
                        <span class="field ${user.allianceRole ? 'has-value' : 'missing'}">AllianceRole</span>
                    </div>
                </div>
            `;
        }
        
        async function fixUserDocuments() {
            if (analysisData.issues.length === 0) {
                showStatus('Keine User-Dokumente zum Korrigieren gefunden!', 'warning');
                return;
            }
            
            if (!confirm(`${analysisData.issues.length} User-Dokumente korrigieren?`)) {
                return;
            }
            
            try {
                showStatus('Korrigiere User-Dokumente...', 'info');
                showProgress(true);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < analysisData.issues.length; i++) {
                    const user = analysisData.issues[i];
                    const progress = Math.round(((i + 1) / analysisData.issues.length) * 100);
                    
                    try {
                        updateProgress(progress, `Korrigiere ${user.username}...`);
                        
                        // Hier k√∂nnten spezifische Korrekturen implementiert werden
                        // F√ºr jetzt nur ein Beispiel
                        await db.collection('users').doc(user.userId).update({
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        successCount++;
                        
                    } catch (error) {
                        console.error(`Fehler bei User ${user.username}:`, error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'Korrektur abgeschlossen');
                showStatus(`User-Dokumente korrigiert: ${successCount} erfolgreich, ${errorCount} Fehler`, 'success');
                
                // Neu analysieren
                setTimeout(() => {
                    analyzeUserDocuments();
                }, 2000);
                
            } catch (error) {
                console.error('Fehler bei der Korrektur:', error);
                showStatus('Fehler bei der Korrektur: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        async function createMissingUserDocuments() {
            if (!confirm('Fehlende User-Dokumente erstellen? Dies erstellt Standard-Dokumente f√ºr User ohne Firestore-Eintr√§ge.')) {
                return;
            }
            
            try {
                showStatus('Erstelle fehlende User-Dokumente...', 'info');
                showProgress(true);
                
                // Hier k√∂nnte Logik implementiert werden, um fehlende User-Dokumente zu erstellen
                // basierend auf Firebase Auth Usern ohne Firestore-Eintr√§ge
                
                showStatus('Feature noch nicht implementiert', 'warning');
                
            } catch (error) {
                console.error('Fehler beim Erstellen:', error);
                showStatus('Fehler beim Erstellen: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        function showProgress(show) {
            document.getElementById('progress-container').style.display = show ? 'block' : 'none';
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // Nach 10 Sekunden ausblenden
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 10000);
        }
        
        // Beim Laden der Seite User-Dokumente analysieren
        document.addEventListener('DOMContentLoaded', () => {
            analyzeUserDocuments();
        });
    </script>
</body>
</html>