<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Spezifischer Benutzer - Spacenations Tools</title>
    <style>
        :root {
            --primary: #00FF88;
            --bg-dark: #0A0A0A;
            --bg-card: #111111;
            --border: rgba(0, 255, 136, 0.2);
            --text-primary: #FFFFFF;
            --text-secondary: #C0C0C0;
            --error: #FF4444;
            --success: #00FF88;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .user-info {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .user-info h3 {
            color: var(--primary);
            margin-bottom: 16px;
        }
        
        .section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .section h3 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 20px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 8px 8px 0;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #00CC6A;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        
        .result.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--success);
        }
        
        .result.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--error);
        }
        
        .result.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 255, 136, 0.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üîç Debug: t.o@trend4media.de</h1>
            <p class="subtitle">Spezifische Diagnose f√ºr den Admin-Benutzer</p>
        </div>
        
        <div class="user-info">
            <h3>üìã Bekannte Benutzerinformationen</h3>
            <p><strong>E-Mail:</strong> t.o@trend4media.de</p>
            <p><strong>Firebase Auth UID:</strong> xibc80UQXbWsC34iQJnyHlMOVk62</p>
            <p><strong>Erstellt:</strong> 15.08.2025</p>
            <p><strong>Letzter Login:</strong> 13.09.2025</p>
            <p><strong>Status:</strong> ‚úÖ Existiert in Firebase Auth</p>
            <p><strong>Firestore:</strong> ‚úÖ Existiert als Super-Admin</p>
        </div>
        
        <div class="section">
            <h3>üîç Firebase Auth Verifikation</h3>
            <p>√úberpr√ºft, ob der Benutzer in Firebase Authentication erkannt wird</p>
            <button class="btn" onclick="checkFirebaseAuth()">Firebase Auth pr√ºfen</button>
            <div id="auth-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üìä Firestore Verifikation</h3>
            <p>√úberpr√ºft, ob der Benutzer in Firestore erkannt wird</p>
            <button class="btn" onclick="checkFirestore()">Firestore pr√ºfen</button>
            <div id="firestore-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üîê Direkter Login-Test</h3>
            <p>Testet den direkten Login mit Firebase Auth</p>
            <div class="form-group">
                <label class="form-label" for="test-password">Passwort f√ºr Test-Login</label>
                <input type="password" id="test-password" class="form-input" placeholder="Passwort eingeben">
            </div>
            <button class="btn" onclick="testDirectLogin()">Direkten Login testen</button>
            <div id="login-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üõ†Ô∏è Firestore-Regeln Problem</h3>
            <p>Das Hauptproblem sind die Firestore-Sicherheitsregeln</p>
            <button class="btn" onclick="showRulesFix()">Regeln-Fix anzeigen</button>
            <div id="rules-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>üöÄ Direkte L√∂sungen</h3>
            <p>Nach Reparatur der Firestore-Regeln:</p>
            <a href="admin-login.html" class="btn">üîê Admin-Login testen</a>
            <a href="test-complete-system.html" class="btn">üß™ System-Test</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Neue System-Dateien -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    
    <script>
        const TARGET_EMAIL = 't.o@trend4media.de';
        const TARGET_UID = 'xibc80UQXbWsC34iQJnyHlMOVk62';
        
        // Utility functions
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }
        
        async function waitForFirebase() {
            if (!window.FirebaseConfig) {
                await new Promise(resolve => {
                    const checkFirebase = setInterval(() => {
                        if (window.FirebaseConfig) {
                            clearInterval(checkFirebase);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            await window.FirebaseConfig.waitForReadyWithTimeout(10000);
        }
        
        // Firebase Auth pr√ºfen
        async function checkFirebaseAuth() {
            try {
                showResult('auth-result', 'üîÑ Pr√ºfe Firebase Auth...', 'info');
                
                await waitForFirebase();
                
                const auth = window.FirebaseConfig.getAuth();
                if (!auth) {
                    showResult('auth-result', '‚ùå Firebase Auth nicht verf√ºgbar', 'error');
                    return;
                }
                
                let result = `üîê Firebase Auth Verifikation:\n\n`;
                result += `üìã Target User: ${TARGET_EMAIL}\n`;
                result += `üìã Expected UID: ${TARGET_UID}\n\n`;
                
                // Test fetchSignInMethodsForEmail
                try {
                    const methods = await auth.fetchSignInMethodsForEmail(TARGET_EMAIL);
                    result += `üîç fetchSignInMethodsForEmail:\n`;
                    result += `‚Ä¢ Methoden gefunden: ${methods.length}\n`;
                    
                    if (methods.length > 0) {
                        result += `‚Ä¢ Methoden: ${methods.join(', ')}\n`;
                        result += `‚Ä¢ Status: ‚úÖ Benutzer existiert in Firebase Auth\n`;
                    } else {
                        result += `‚Ä¢ Status: ‚ùå Benutzer existiert NICHT in Firebase Auth\n`;
                        result += `‚Ä¢ Das erkl√§rt das Problem!\n`;
                    }
                    
                } catch (methodsError) {
                    result += `‚ùå fetchSignInMethodsForEmail Fehler: ${methodsError.message}\n`;
                }
                
                // Test mit direkter UID-Abfrage (falls m√∂glich)
                try {
                    const currentUser = auth.currentUser;
                    result += `\nüë§ Aktueller Auth-User:\n`;
                    result += `‚Ä¢ Angemeldet: ${currentUser ? '‚úÖ' : '‚ùå'}\n`;
                    if (currentUser) {
                        result += `‚Ä¢ E-Mail: ${currentUser.email}\n`;
                        result += `‚Ä¢ UID: ${currentUser.uid}\n`;
                        result += `‚Ä¢ Ist Target User: ${currentUser.email === TARGET_EMAIL ? '‚úÖ' : '‚ùå'}\n`;
                    }
                } catch (userError) {
                    result += `\n‚ùå Aktueller User Fehler: ${userError.message}\n`;
                }
                
                showResult('auth-result', result, 'info');
                
            } catch (error) {
                console.error('Firebase Auth check failed:', error);
                showResult('auth-result', `‚ùå Firebase Auth Check fehlgeschlagen:\n${error.message}`, 'error');
            }
        }
        
        // Firestore pr√ºfen
        async function checkFirestore() {
            try {
                showResult('firestore-result', 'üîÑ Pr√ºfe Firestore...', 'info');
                
                await waitForFirebase();
                
                const db = window.FirebaseConfig.getDB();
                if (!db) {
                    showResult('firestore-result', '‚ùå Firestore nicht verf√ºgbar', 'error');
                    return;
                }
                
                let result = `üìä Firestore Verifikation:\n\n`;
                
                // Suche nach E-Mail
                try {
                    const emailQuery = await db.collection('users')
                        .where('email', '==', TARGET_EMAIL)
                        .limit(1)
                        .get();
                    
                    result += `üîç Suche nach E-Mail (${TARGET_EMAIL}):\n`;
                    result += `‚Ä¢ Gefunden: ${!emailQuery.empty ? '‚úÖ' : '‚ùå'}\n`;
                    
                    if (!emailQuery.empty) {
                        const userData = emailQuery.docs[0].data();
                        const docId = emailQuery.docs[0].id;
                        
                        result += `‚Ä¢ Dokument-ID: ${docId}\n`;
                        result += `‚Ä¢ UID im Dokument: ${userData.uid || 'Nicht gesetzt'}\n`;
                        result += `‚Ä¢ Username: ${userData.username}\n`;
                        result += `‚Ä¢ Super-Admin: ${userData.isSuperAdmin ? '‚úÖ' : '‚ùå'}\n`;
                        result += `‚Ä¢ Allianz-Admin: ${userData.isAllianceAdmin ? '‚úÖ' : '‚ùå'}\n`;
                        result += `‚Ä¢ Aktiv: ${userData.isActive ? '‚úÖ' : '‚ùå'}\n`;
                        
                        // UID-Vergleich
                        if (userData.uid === TARGET_UID) {
                            result += `‚Ä¢ UID-Match: ‚úÖ Stimmt √ºberein\n`;
                        } else if (docId === TARGET_UID) {
                            result += `‚Ä¢ UID-Match: ‚ö†Ô∏è Dokument-ID stimmt √ºberein, aber uid-Feld ist anders\n`;
                        } else {
                            result += `‚Ä¢ UID-Match: ‚ùå Stimmt nicht √ºberein\n`;
                            result += `  Expected: ${TARGET_UID}\n`;
                            result += `  Found: ${userData.uid || docId}\n`;
                        }
                    }
                    
                } catch (emailError) {
                    result += `‚ùå E-Mail-Suche fehlgeschlagen: ${emailError.message}\n`;
                }
                
                // Suche nach UID
                try {
                    const uidDoc = await db.collection('users').doc(TARGET_UID).get();
                    
                    result += `\nüîç Suche nach UID (${TARGET_UID}):\n`;
                    result += `‚Ä¢ Dokument existiert: ${uidDoc.exists ? '‚úÖ' : '‚ùå'}\n`;
                    
                    if (uidDoc.exists) {
                        const userData = uidDoc.data();
                        result += `‚Ä¢ E-Mail: ${userData.email}\n`;
                        result += `‚Ä¢ Username: ${userData.username}\n`;
                        result += `‚Ä¢ E-Mail-Match: ${userData.email === TARGET_EMAIL ? '‚úÖ' : '‚ùå'}\n`;
                    }
                    
                } catch (uidError) {
                    result += `‚ùå UID-Suche fehlgeschlagen: ${uidError.message}\n`;
                }
                
                showResult('firestore-result', result, 'info');
                
            } catch (error) {
                console.error('Firestore check failed:', error);
                showResult('firestore-result', `‚ùå Firestore Check fehlgeschlagen:\n${error.message}`, 'error');
            }
        }
        
        // Direkter Login-Test
        async function testDirectLogin() {
            try {
                const password = document.getElementById('test-password').value;
                if (!password) {
                    alert('Bitte geben Sie ein Passwort ein');
                    return;
                }
                
                showResult('login-result', 'üîÑ Teste direkten Login...', 'info');
                
                await waitForFirebase();
                
                const auth = window.FirebaseConfig.getAuth();
                if (!auth) {
                    showResult('login-result', '‚ùå Firebase Auth nicht verf√ºgbar', 'error');
                    return;
                }
                
                let result = `üîê Direkter Login-Test:\n\n`;
                result += `üìß E-Mail: ${TARGET_EMAIL}\n`;
                result += `üîë Passwort: [${password.length} Zeichen]\n\n`;
                
                try {
                    // Direkter Firebase Auth Login
                    const userCredential = await auth.signInWithEmailAndPassword(TARGET_EMAIL, password);
                    const user = userCredential.user;
                    
                    result += `‚úÖ Firebase Auth Login erfolgreich!\n`;
                    result += `‚Ä¢ UID: ${user.uid}\n`;
                    result += `‚Ä¢ E-Mail: ${user.email}\n`;
                    result += `‚Ä¢ E-Mail verifiziert: ${user.emailVerified ? '‚úÖ' : '‚ùå'}\n`;
                    result += `‚Ä¢ UID-Match: ${user.uid === TARGET_UID ? '‚úÖ' : '‚ùå'}\n`;
                    
                    // Teste Firestore-Zugriff mit angemeldetem User
                    try {
                        const db = window.FirebaseConfig.getDB();
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        result += `\nüìä Firestore-Zugriff (angemeldet):\n`;
                        result += `‚Ä¢ Dokument gefunden: ${userDoc.exists ? '‚úÖ' : '‚ùå'}\n`;
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            result += `‚Ä¢ Username: ${userData.username}\n`;
                            result += `‚Ä¢ Super-Admin: ${userData.isSuperAdmin ? '‚úÖ' : '‚ùå'}\n`;
                            
                            if (userData.isSuperAdmin) {
                                result += `\nüéâ ADMIN-LOGIN SOLLTE FUNKTIONIEREN!\n`;
                                result += `Der Benutzer ist korrekt angemeldet und hat Super-Admin-Rechte.\n`;
                            }
                        }
                        
                    } catch (firestoreError) {
                        result += `\n‚ùå Firestore-Zugriff fehlgeschlagen: ${firestoreError.message}\n`;
                        if (firestoreError.code === 'permission-denied') {
                            result += `üîí FIRESTORE-REGELN PROBLEM!\n`;
                            result += `Die Sicherheitsregeln blockieren den Zugriff.\n`;
                        }
                    }
                    
                    // Logout nach Test
                    await auth.signOut();
                    result += `\nüö™ Test-Logout durchgef√ºhrt\n`;
                    
                    showResult('login-result', result, 'success');
                    
                } catch (loginError) {
                    result += `‚ùå Firebase Auth Login fehlgeschlagen!\n`;
                    result += `‚Ä¢ Fehler: ${loginError.message}\n`;
                    result += `‚Ä¢ Code: ${loginError.code || 'Unbekannt'}\n`;
                    
                    switch (loginError.code) {
                        case 'auth/user-not-found':
                            result += `\nüö® PROBLEM: Benutzer existiert NICHT in Firebase Auth!\n`;
                            result += `Obwohl Sie sagten, er existiert. M√∂gliche Ursachen:\n`;
                            result += `‚Ä¢ Falsches Firebase-Projekt\n`;
                            result += `‚Ä¢ Browser-Cache-Problem\n`;
                            result += `‚Ä¢ Benutzer wurde gel√∂scht\n`;
                            break;
                        case 'auth/wrong-password':
                            result += `\n‚úÖ BENUTZER EXISTIERT, aber falsches Passwort\n`;
                            result += `Das best√§tigt, dass der Benutzer in Firebase Auth ist.\n`;
                            break;
                        case 'auth/invalid-email':
                            result += `\n‚ùå E-Mail-Format-Problem\n`;
                            break;
                        default:
                            result += `\n‚ùì Unbekannter Fehler\n`;
                    }
                    
                    showResult('login-result', result, loginError.code === 'auth/wrong-password' ? 'warning' : 'error');
                }
                
            } catch (error) {
                console.error('Direct login test failed:', error);
                showResult('login-result', `‚ùå Direkter Login-Test fehlgeschlagen:\n${error.message}`, 'error');
            }
        }
        
        // Firestore-Regeln-Fix anzeigen
        async function showRulesFix() {
            const result = `üîí Firestore-Regeln reparieren:

üö® HAUPTPROBLEM:
Die Firestore-Sicherheitsregeln blockieren ALLE Zugriffe.
Das verhindert sowohl Login-Verifikation als auch Analytics.

üõ†Ô∏è SOFORTL√ñSUNG:
1. Gehen Sie zu: https://console.firebase.google.com/project/spacenations-tools/firestore/rules

2. Ersetzen Sie die aktuellen Regeln durch diese TEMPOR√ÑRE TEST-REGEL:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // TEMPOR√ÑRE TEST-REGEL - Erlaubt alle Zugriffe
    match /{document=**} {
      allow read, write: if true;
    }
  }
}

3. Klicken Sie "Publish"

4. Testen Sie das Admin-Login erneut

üîí NACH DEM TEST:
Ersetzen Sie die Test-Regel durch die sichere Version aus FIRESTORE_RULES_FIX.txt

‚ö° WARUM DAS FUNKTIONIERT:
‚Ä¢ Firebase Auth funktioniert unabh√§ngig von Firestore-Regeln
‚Ä¢ Firestore-Regeln blockieren nur Datenbank-Zugriffe
‚Ä¢ Mit offenen Regeln kann das System Benutzerdaten lesen
‚Ä¢ Admin-Login kann dann Super-Admin-Status verifizieren

üéØ ERWARTETES ERGEBNIS:
Nach der Regel-Aktualisierung sollte das Admin-Login
f√ºr t.o@trend4media.de sofort funktionieren!`;

            showResult('rules-result', result, 'info');
        }
        
        // Auto-Checks beim Laden
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Warte kurz und f√ºhre dann Auto-Checks durch
                setTimeout(async () => {
                    await checkFirebaseAuth();
                    await checkFirestore();
                }, 2000);
                
            } catch (error) {
                console.error('Auto-checks failed:', error);
            }
        });
    </script>
</body>
</html>