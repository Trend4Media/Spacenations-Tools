<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Data Fix - Spacenations Tools</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0A0A0A;
            color: #FFFFFF;
            padding: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #1A1A1A;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00FF88;
        }
        
        h1 {
            color: #00FF88;
            margin-bottom: 30px;
        }
        
        .btn {
            background: #00FF88;
            color: #000000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn:hover {
            background: #44FF99;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.danger {
            background: #F44336;
            color: #FFFFFF;
        }
        
        .btn.danger:hover {
            background: #E57373;
        }
        
        .btn.warning {
            background: #FF9800;
            color: #000000;
        }
        
        .btn.warning:hover {
            background: #FFB74D;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: left;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid #F44336;
        }
        
        .info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
            border: 1px solid #2196F3;
        }
        
        .warning {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
            border: 1px solid #FF9800;
        }
        
        .data-table {
            background: #2A2A2A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00FF88;
        }
        
        .user-item.needs-fix {
            border-left-color: #FF9800;
        }
        
        .user-item.fixed {
            border-left-color: #4CAF50;
        }
        
        .user-item h4 {
            margin: 0 0 10px 0;
            color: #00FF88;
        }
        
        .user-item p {
            margin: 5px 0;
            color: #CCC;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #00FF88;
            transition: width 0.3s ease;
        }
        
        .fix-options {
            background: #2A2A2A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .fix-options h3 {
            color: #00FF88;
            margin-bottom: 15px;
        }
        
        .fix-options ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .fix-options li {
            margin: 5px 0;
            color: #CCC;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Alliance Data Fix Tool</h1>
        <p>Korrigiert falsche Alliance-Daten in der Firestore-Datenbank</p>
        
        <div class="fix-options">
            <h3>üîß Was wird korrigiert:</h3>
            <ul>
                <li><strong>Alliance-Feld:</strong> Ersetzt Alliance-IDs durch Alliance-Namen</li>
                <li><strong>Alliance-Tag:</strong> F√ºgt fehlende Alliance-Tags hinzu</li>
                <li><strong>Alliance-Role:</strong> Stellt korrekte Rollen wieder her</li>
                <li><strong>Daten-Konsistenz:</strong> Synchronisiert User mit Alliance-Daten</li>
            </ul>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progress-text">Bereite Korrektur vor...</p>
        </div>
        
        <div id="data-table" class="data-table" style="display: none;">
            <h3>üë• Gefundene User mit Alliance-Daten:</h3>
            <div id="user-items"></div>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="btn" onclick="analyzeAllianceData()">üîç Alliance-Daten analysieren</button>
            <button class="btn warning" onclick="fixAllianceData()" id="fix-btn" style="display: none;">üîß Alliance-Daten korrigieren</button>
            <button class="btn danger" onclick="resetAllianceData()" id="reset-btn" style="display: none;">üóëÔ∏è Alle Alliance-Daten zur√ºcksetzen</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: 'AIzaSyDr4-ap_EubUn0UdP7hkEpS2jkzLIVgvyc',
            authDomain: 'spacenations-tools.firebaseapp.com',
            projectId: 'spacenations-tools',
            storageBucket: 'spacenations-tools.firebasestorage.app',
            messagingSenderId: '651338201276',
            appId: '1:651338201276:web:89e7d9c19dbd2611d3f8b9',
            measurementId: 'G-SKWJWH2ERX'
        };
        
        // Firebase initialisieren
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();
        
        let analysisData = {
            users: [],
            alliances: [],
            needsFix: [],
            fixed: []
        };
        
        async function analyzeAllianceData() {
            try {
                showStatus('Analysiere Alliance-Daten...', 'info');
                showProgress(true);
                updateProgress(10, 'Lade User-Daten...');
                
                // Lade alle User
                const usersSnapshot = await db.collection('users').get();
                analysisData.users = usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateProgress(30, 'Lade Alliance-Daten...');
                
                // Lade alle Allianzen
                const alliancesSnapshot = await db.collection('alliances').get();
                analysisData.alliances = alliancesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateProgress(50, 'Analysiere Alliance-Zuordnungen...');
                
                // Analysiere welche User korrigiert werden m√ºssen
                analysisData.needsFix = [];
                analysisData.fixed = [];
                
                for (const user of analysisData.users) {
                    if (user.alliance && user.allianceRole) {
                        // Pr√ºfe ob alliance-Feld eine ID ist (sollte Name sein)
                        const isAllianceId = analysisData.alliances.some(alliance => alliance.id === user.alliance);
                        const isAllianceName = analysisData.alliances.some(alliance => alliance.name === user.alliance);
                        
                        if (isAllianceId) {
                            // User hat Alliance-ID statt Name - muss korrigiert werden
                            const alliance = analysisData.alliances.find(a => a.id === user.alliance);
                            analysisData.needsFix.push({
                                ...user,
                                currentAlliance: user.alliance,
                                correctAlliance: alliance.name,
                                correctAllianceTag: alliance.tag,
                                allianceId: alliance.id
                            });
                        } else if (isAllianceName) {
                            // User hat korrekten Alliance-Namen
                            const alliance = analysisData.alliances.find(a => a.name === user.alliance);
                            analysisData.fixed.push({
                                ...user,
                                allianceTag: alliance ? alliance.tag : 'Unbekannt'
                            });
                        }
                    }
                }
                
                updateProgress(100, 'Analyse abgeschlossen');
                
                displayAnalysisResults();
                showStatus(`Analyse abgeschlossen: ${analysisData.needsFix.length} User m√ºssen korrigiert werden, ${analysisData.fixed.length} User sind korrekt`, 'success');
                
                // Zeige Fix-Button
                if (analysisData.needsFix.length > 0) {
                    document.getElementById('fix-btn').style.display = 'inline-block';
                }
                document.getElementById('reset-btn').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Fehler bei der Analyse:', error);
                showStatus('Fehler bei der Analyse: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        function displayAnalysisResults() {
            const dataTable = document.getElementById('data-table');
            const userItems = document.getElementById('user-items');
            
            dataTable.style.display = 'block';
            
            let html = '';
            
            // User die korrigiert werden m√ºssen
            if (analysisData.needsFix.length > 0) {
                html += '<h4 style="color: #FF9800;">‚ö†Ô∏è User die korrigiert werden m√ºssen:</h4>';
                analysisData.needsFix.forEach(user => {
                    html += createUserItem(user, 'needs-fix');
                });
            }
            
            // User die bereits korrekt sind
            if (analysisData.fixed.length > 0) {
                html += '<h4 style="color: #4CAF50;">‚úÖ User die bereits korrekt sind:</h4>';
                analysisData.fixed.forEach(user => {
                    html += createUserItem(user, 'fixed');
                });
            }
            
            userItems.innerHTML = html;
        }
        
        function createUserItem(user, type) {
            const isNeedsFix = type === 'needs-fix';
            
            return `
                <div class="user-item ${type}">
                    <h4>${user.username || user.id}</h4>
                    <p><strong>E-Mail:</strong> ${user.email || 'Unbekannt'}</p>
                    <p><strong>Aktuelle Alliance:</strong> ${user.currentAlliance || user.alliance || 'Keine'}</p>
                    ${isNeedsFix ? `<p><strong>Korrekte Alliance:</strong> ${user.correctAlliance} [${user.correctAllianceTag}]</p>` : ''}
                    <p><strong>Alliance-Rolle:</strong> ${user.allianceRole || 'Keine'}</p>
                    <p><strong>Status:</strong> ${isNeedsFix ? 'Muss korrigiert werden' : 'Korrekt'}</p>
                </div>
            `;
        }
        
        async function fixAllianceData() {
            if (analysisData.needsFix.length === 0) {
                showStatus('Keine User zum Korrigieren gefunden!', 'warning');
                return;
            }
            
            if (!confirm(`${analysisData.needsFix.length} User korrigieren?`)) {
                return;
            }
            
            try {
                showStatus('Korrigiere Alliance-Daten...', 'info');
                showProgress(true);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < analysisData.needsFix.length; i++) {
                    const user = analysisData.needsFix[i];
                    const progress = Math.round(((i + 1) / analysisData.needsFix.length) * 100);
                    
                    try {
                        updateProgress(progress, `Korrigiere ${user.username}...`);
                        
                        // Korrigiere User-Dokument
                        await db.collection('users').doc(user.id).update({
                            alliance: user.correctAlliance,
                            allianceTag: user.correctAllianceTag,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        successCount++;
                        
                    } catch (error) {
                        console.error(`Fehler bei User ${user.username}:`, error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'Korrektur abgeschlossen');
                showStatus(`Alliance-Daten korrigiert: ${successCount} erfolgreich, ${errorCount} Fehler`, 'success');
                
                // Neu analysieren
                setTimeout(() => {
                    analyzeAllianceData();
                }, 2000);
                
            } catch (error) {
                console.error('Fehler bei der Korrektur:', error);
                showStatus('Fehler bei der Korrektur: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        async function resetAllianceData() {
            if (!confirm('ALLE Alliance-Daten von ALLEN Usern zur√ºcksetzen?')) {
                return;
            }
            
            if (!confirm('Wirklich ALLE Alliance-Daten l√∂schen? Das kann nicht r√ºckg√§ngig gemacht werden!')) {
                return;
            }
            
            try {
                showStatus('Setze alle Alliance-Daten zur√ºck...', 'warning');
                showProgress(true);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < analysisData.users.length; i++) {
                    const user = analysisData.users[i];
                    const progress = Math.round(((i + 1) / analysisData.users.length) * 100);
                    
                    try {
                        updateProgress(progress, `Setze Alliance-Daten f√ºr ${user.username || user.id} zur√ºck...`);
                        
                        // Entferne Alliance-Daten
                        await db.collection('users').doc(user.id).update({
                            alliance: null,
                            allianceTag: null,
                            allianceRole: null,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        successCount++;
                        
                    } catch (error) {
                        console.error(`Fehler bei User ${user.username || user.id}:`, error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'Reset abgeschlossen');
                showStatus(`Alliance-Daten zur√ºckgesetzt: ${successCount} erfolgreich, ${errorCount} Fehler`, 'success');
                
                // Neu analysieren
                setTimeout(() => {
                    analyzeAllianceData();
                }, 2000);
                
            } catch (error) {
                console.error('Fehler beim Reset:', error);
                showStatus('Fehler beim Reset: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        function showProgress(show) {
            document.getElementById('progress-container').style.display = show ? 'block' : 'none';
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // Nach 10 Sekunden ausblenden
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 10000);
        }
        
        // Beim Laden der Seite Alliance-Daten analysieren
        document.addEventListener('DOMContentLoaded', () => {
            analyzeAllianceData();
        });
    </script>
</body>
</html>