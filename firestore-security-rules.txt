rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User documents - users can read/write their own data, others can read for username lookup
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }
    
    // Alliance documents - authenticated users can read, admins can write
    match /alliances/{allianceId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (resource.data.admin == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole == 'superadmin');
    }
    
    // Alliance permissions - authenticated users can read, admins can write
    match /alliancePermissions/{allianceId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (get(/databases/$(database)/documents/alliances/$(allianceId)).data.admin == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole == 'superadmin');
    }
    
    // Alliance chat - members can read/write
    match /allianceChat/{allianceId} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/alliances/$(allianceId)).data.members[request.auth.uid] != null;
    }
    
    // User activities - users can write their own activities
    match /userActivities/{activityId} {
      allow read, write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole == 'superadmin');
      allow create: if request.auth != null;
    }
    
    // User password changes - users can write their own changes
    match /userPasswordChanges/{changeId} {
      allow read, write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole == 'superadmin');
      allow create: if request.auth != null;
    }
    
    // User raids - users can write their own raids
    match /userRaids/{raidId} {
      allow read, write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole == 'superadmin');
      allow create: if request.auth != null;
    }
    
    // User sabotages - users can write their own sabotages
    match /userSabotages/{sabotageId} {
      allow read, write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole == 'superadmin');
      allow create: if request.auth != null;
    }
    
    // User battles - users can write their own battles
    match /userBattles/{battleId} {
      allow read, write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole == 'superadmin');
      allow create: if request.auth != null;
    }
    
    // Alliance spy reports - alliance members can read/write
    match /allianceSpyReports/{reportId} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/alliances/$(resource.data.allianceId)).data.members[request.auth.uid] != null;
      allow create: if request.auth != null;
    }
    
    // Alliance activity logs - alliance members can read/write
    match /allianceActivityLogs/{logId} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/alliances/$(resource.data.allianceId)).data.members[request.auth.uid] != null;
      allow create: if request.auth != null;
    }
    
    // Alliance activities - alliance members can read/write
    match /allianceActivities/{activityId} {
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/alliances/$(resource.data.allianceId)).data.members[request.auth.uid] != null;
      allow create: if request.auth != null;
    }
    
    // Error logs - authenticated users can write, admins can read
    match /errorLogs/{logId} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.systemRole in ['admin', 'superadmin'];
      allow write: if request.auth != null;
    }
    
    // Test documents - authenticated users can read/write
    match /test/{document} {
      allow read, write: if request.auth != null;
    }
  }
}