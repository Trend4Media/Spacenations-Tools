<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Debug Tool - Spacenations Tools</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0A0A0A;
            color: #00FF88;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #111111;
            border: 2px solid #00FF88;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #00FF88;
            color: #0A0A0A;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .test-button:hover {
            background: #44FF99;
        }
        .result {
            background: #1A1A1A;
            border: 1px solid #2A2A2A;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .success { border-color: #00FF88; color: #00FF88; }
        .error { border-color: #FF3B30; color: #FF3B30; }
        .warning { border-color: #FFA500; color: #FFA500; }
        input {
            background: #1A1A1A;
            border: 1px solid #2A2A2A;
            color: #00FF88;
            padding: 8px;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firebase Debug Tool</h1>
        <p>Dieses Tool hilft bei der Diagnose von Firebase-Problemen.</p>
        
        <div class="test-section">
            <h2>1. Firebase-Verbindung testen</h2>
            <button class="test-button" onclick="testFirebaseConnection()">Firebase-Verbindung testen</button>
            <div id="connection-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>2. Firestore-Berechtigungen testen</h2>
            <button class="test-button" onclick="testFirestorePermissions()">Firestore-Berechtigungen testen</button>
            <div id="permissions-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>3. Benutzer-Suche testen</h2>
            <input type="text" id="test-username" placeholder="Benutzername eingeben" value="Daikin">
            <button class="test-button" onclick="testUserSearch()">Benutzer-Suche testen</button>
            <div id="user-search-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>4. E-Mail-Verf√ºgbarkeit testen</h2>
            <input type="email" id="test-email" placeholder="E-Mail eingeben" value="t.o@trend4media.de">
            <button class="test-button" onclick="testEmailAvailability()">E-Mail-Verf√ºgbarkeit testen</button>
            <div id="email-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>5. Vollst√§ndiger Login-Test</h2>
            <input type="text" id="login-input" placeholder="Benutzername oder E-Mail" value="t.o@trend4media.de">
            <input type="password" id="login-password" placeholder="Passwort" value="test123">
            <button class="test-button" onclick="testFullLogin()">Vollst√§ndiger Login-Test</button>
            <div id="login-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>6. System-Status</h2>
            <button class="test-button" onclick="showSystemStatus()">System-Status anzeigen</button>
            <div id="system-status" class="result"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Scripts -->
    <script src="js/logger.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-manager.js"></script>

    <script>
        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        async function testFirebaseConnection() {
            logResult('connection-result', 'Teste Firebase-Verbindung...', 'warning');
            
            try {
                // Warten bis Firebase geladen ist
                await new Promise((resolve) => {
                    const checkFirebase = setInterval(() => {
                        if (window.firebase && window.firebase.apps && window.firebase.apps.length > 0) {
                            clearInterval(checkFirebase);
                            resolve();
                        }
                    }, 100);
                    
                    setTimeout(() => {
                        clearInterval(checkFirebase);
                        resolve();
                    }, 5000);
                });
                
                if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                    throw new Error('Firebase nicht initialisiert');
                }
                
                const app = window.firebase.apps[0];
                const auth = window.firebase.auth();
                const db = window.firebase.firestore();
                
                logResult('connection-result', 
                    `‚úÖ Firebase erfolgreich verbunden!\n` +
                    `App: ${app.name}\n` +
                    `Auth: ${auth ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'}\n` +
                    `Firestore: ${db ? 'Verf√ºgbar' : 'Nicht verf√ºgbar'}`, 
                    'success'
                );
                
            } catch (error) {
                logResult('connection-result', `‚ùå Firebase-Verbindung fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function testFirestorePermissions() {
            logResult('permissions-result', 'Teste Firestore-Berechtigungen...', 'warning');
            
            try {
                if (!window.firebase || !window.firebase.firestore) {
                    throw new Error('Firebase Firestore nicht verf√ºgbar');
                }
                
                const db = window.firebase.firestore();
                
                // Test 1: Einfache Collection lesen
                const testCollection = await db.collection('test').limit(1).get();
                logResult('permissions-result', 
                    `‚úÖ Firestore-Berechtigungen OK!\n` +
                    `Test-Collection gelesen: ${testCollection.size} Dokumente\n` +
                    `Berechtigungen: Lese-Zugriff funktioniert`, 
                    'success'
                );
                
            } catch (error) {
                if (error.code === 'permission-denied') {
                    logResult('permissions-result', 
                        `‚ùå Firestore-Berechtigungen verweigert!\n` +
                        `Fehler: ${error.message}\n\n` +
                        `L√ñSUNG: Aktualisieren Sie die Firestore-Sicherheitsregeln in der Firebase Console:\n` +
                        `https://console.firebase.google.com/u/0/project/spacenations-tools/firestore/rules\n\n` +
                        `Verwenden Sie diese Regeln:\n` +
                        `rules_version = '2';\n` +
                        `service cloud.firestore {\n` +
                        `  match /databases/{database}/documents {\n` +
                        `    match /{document=**} {\n` +
                        `      allow read, write: if request.auth != null;\n` +
                        `    }\n` +
                        `  }\n` +
                        `}`, 
                        'error'
                    );
                } else {
                    logResult('permissions-result', `‚ùå Firestore-Fehler:\n${error.message}`, 'error');
                }
            }
        }

        async function testUserSearch() {
            const username = document.getElementById('test-username').value;
            logResult('user-search-result', `Suche Benutzer: ${username}...`, 'warning');
            
            try {
                if (!window.firebase || !window.firebase.firestore) {
                    throw new Error('Firebase Firestore nicht verf√ºgbar');
                }
                
                const db = window.firebase.firestore();
                const userQuery = await db.collection('users')
                    .where('username', '==', username)
                    .limit(1)
                    .get();
                
                if (userQuery.empty) {
                    logResult('user-search-result', 
                        `‚ùå Benutzer nicht gefunden: ${username}\n` +
                        `M√∂gliche Ursachen:\n` +
                        `- Benutzername existiert nicht in der Datenbank\n` +
                        `- Firestore-Berechtigungen blockieren die Suche\n` +
                        `- Benutzer ist nicht in der 'users' Collection`, 
                        'error'
                    );
                } else {
                    const userDoc = userQuery.docs[0];
                    const userData = userDoc.data();
                    logResult('user-search-result', 
                        `‚úÖ Benutzer gefunden!\n` +
                        `Username: ${userData.username}\n` +
                        `Email: ${userData.email}\n` +
                        `SystemRole: ${userData.systemRole}\n` +
                        `IsActive: ${userData.isActive}`, 
                        'success'
                    );
                }
                
            } catch (error) {
                logResult('user-search-result', `‚ùå Benutzer-Suche fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function testEmailAvailability() {
            const email = document.getElementById('test-email').value;
            logResult('email-result', `Pr√ºfe E-Mail-Verf√ºgbarkeit: ${email}...`, 'warning');
            
            try {
                if (!window.firebase || !window.firebase.auth) {
                    throw new Error('Firebase Auth nicht verf√ºgbar');
                }
                
                const auth = window.firebase.auth();
                const methods = await auth.fetchSignInMethodsForEmail(email);
                
                if (methods.length === 0) {
                    logResult('email-result', 
                        `‚ùå E-Mail nicht in Firebase Auth registriert: ${email}\n` +
                        `M√∂gliche Ursachen:\n` +
                        `- Benutzer ist nicht in Firebase Authentication registriert\n` +
                        `- E-Mail-Adresse ist falsch geschrieben\n` +
                        `- Benutzer muss sich zuerst registrieren`, 
                        'error'
                    );
                } else {
                    logResult('email-result', 
                        `‚úÖ E-Mail in Firebase Auth gefunden!\n` +
                        `Email: ${email}\n` +
                        `Verf√ºgbare Methoden: ${methods.join(', ')}`, 
                        'success'
                    );
                }
                
            } catch (error) {
                logResult('email-result', `‚ùå E-Mail-Pr√ºfung fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        async function testFullLogin() {
            const input = document.getElementById('login-input').value;
            const password = document.getElementById('login-password').value;
            logResult('login-result', `Teste Login: ${input}...`, 'warning');
            
            try {
                if (!window.AuthAPI) {
                    throw new Error('AuthAPI nicht verf√ºgbar');
                }
                
                const result = await window.AuthAPI.login(input, password);
                
                if (result.success) {
                    logResult('login-result', 
                        `‚úÖ Login erfolgreich!\n` +
                        `Input: ${input}\n` +
                        `User: ${result.user.email}\n` +
                        `UID: ${result.user.uid}`, 
                        'success'
                    );
                } else {
                    logResult('login-result', 
                        `‚ùå Login fehlgeschlagen!\n` +
                        `Input: ${input}\n` +
                        `Fehler: ${result.error}`, 
                        'error'
                    );
                }
                
            } catch (error) {
                logResult('login-result', `‚ùå Login-Test fehlgeschlagen:\n${error.message}`, 'error');
            }
        }

        function showSystemStatus() {
            const status = {
                'Firebase verf√ºgbar': !!(window.firebase && window.firebase.apps && window.firebase.apps.length > 0),
                'Firebase Auth verf√ºgbar': !!(window.firebase && window.firebase.auth),
                'Firebase Firestore verf√ºgbar': !!(window.firebase && window.firebase.firestore),
                'AuthAPI verf√ºgbar': !!window.AuthAPI,
                'Logger verf√ºgbar': !!window.logger,
                'SessionAPI verf√ºgbar': !!window.SessionAPI,
                'User Agent': navigator.userAgent,
                'URL': window.location.href,
                'Timestamp': new Date().toISOString()
            };
            
            const statusText = Object.entries(status)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
            
            logResult('system-status', statusText, 'info');
        }

        // Automatisch beim Laden starten
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Firebase Debug Tool geladen');
            showSystemStatus();
        });
    </script>
</body>
</html>