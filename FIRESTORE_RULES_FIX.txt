rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users Collection - Benutzer können ihre eigenen Daten lesen/schreiben
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                   (request.auth.uid == userId || 
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true);
    }
    
    // User Activities - Benutzer können ihre eigenen Aktivitäten lesen/schreiben
    match /userActivities/{activityId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // User Stats - Benutzer können ihre eigenen Statistiken lesen/schreiben
    match /userStats/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Analytics Collections - Erlaubt Schreibzugriff für alle authentifizierten Benutzer
    match /analytics_events/{eventId} {
      allow read: if request.auth != null && 
                  get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
      allow write: if true; // Analytics sollten immer funktionieren
    }
    
    match /analytics_sessions/{sessionId} {
      allow read: if request.auth != null && 
                  get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
      allow write: if true; // Analytics sollten immer funktionieren
    }
    
    match /analytics_pageViews/{viewId} {
      allow read: if request.auth != null && 
                  get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
      allow write: if true; // Analytics sollten immer funktionieren
    }
    
    // Alliances - Nur Allianz-Admins und Super-Admins
    match /alliances/{allianceId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                   (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true ||
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAllianceAdmin == true);
    }
    
    // Test Collection - Für Verbindungstests
    match /_test/{testId} {
      allow read, write: if true;
    }
    
    // Fallback für alle anderen Dokumente - nur für Super-Admins
    match /{document=**} {
      allow read, write: if request.auth != null && 
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
    }
  }
}