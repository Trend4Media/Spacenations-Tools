<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log-Checker - Spacenations Tools</title>
    <style>
        :root {
            --primary: #00FF88;
            --bg-dark: #0A0A0A;
            --bg-card: #111111;
            --border: rgba(0, 255, 136, 0.2);
            --text-primary: #FFFFFF;
            --text-secondary: #C0C0C0;
            --error: #FF4444;
            --success: #00FF88;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .section h3 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 20px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 8px 8px 0;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #00CC6A;
            transform: translateY(-2px);
        }
        
        .log-output {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            color: #00FF88;
            white-space: pre-wrap;
        }
        
        .instructions {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .instructions h4 {
            color: #3b82f6;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üìä Log-Checker</h1>
            <p class="subtitle">√úberpr√ºft die Browser-Konsole und System-Logs</p>
        </div>
        
        <div class="instructions">
            <h4>üìã Anweisungen</h4>
            <p><strong>1. √ñffnen Sie die Browser-Entwicklertools:</strong> F12 dr√ºcken</p>
            <p><strong>2. Gehen Sie zum "Console" Tab</strong></p>
            <p><strong>3. Kopieren Sie ALLE Logs</strong> und f√ºgen Sie sie unten ein</p>
            <p><strong>4. Klicken Sie "Logs analysieren"</strong></p>
        </div>
        
        <div class="section">
            <h3>üìù Logs eingeben</h3>
            <p>F√ºgen Sie hier die kompletten Browser-Konsole-Logs ein:</p>
            <textarea id="log-input" placeholder="F√ºgen Sie hier die Browser-Konsole-Logs ein..." 
                style="width: 100%; height: 200px; background: #1a1a1a; color: #00FF88; border: 1px solid #333; border-radius: 8px; padding: 16px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"></textarea>
            <button class="btn" onclick="analyzeLogs()">Logs analysieren</button>
        </div>
        
        <div class="section">
            <h3>üîç Log-Analyse</h3>
            <div id="analysis-output" class="log-output">Keine Logs analysiert...</div>
        </div>
        
        <div class="section">
            <h3>üìä System-Status</h3>
            <p>Aktueller Status der System-Komponenten:</p>
            <button class="btn" onclick="checkSystemStatus()">System-Status pr√ºfen</button>
            <div id="status-output" class="log-output">System-Status nicht gepr√ºft...</div>
        </div>
        
        <div class="section">
            <h3>üõ†Ô∏è Schnelle Aktionen</h3>
            <p>Basierend auf der Log-Analyse:</p>
            <button class="btn" onclick="clearAllLogs()">Alle Logs l√∂schen</button>
            <button class="btn" onclick="exportLogs()">Logs exportieren</button>
            <a href="debug-login-logout-cycle.html" class="btn">üîç Login-Debug</a>
            <a href="fix-redirect-loop.html" class="btn">üîÑ Redirect-Debug</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- System-Dateien -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/firebase-sync.js"></script>
    
    <script>
        // Logs analysieren
        function analyzeLogs() {
            const logInput = document.getElementById('log-input').value;
            const analysisOutput = document.getElementById('analysis-output');
            
            if (!logInput.trim()) {
                analysisOutput.textContent = 'Keine Logs eingegeben. Bitte f√ºgen Sie die Browser-Konsole-Logs ein.';
                return;
            }
            
            let analysis = 'üîç LOG-ANALYSE:\n\n';
            
            // Analysiere verschiedene Aspekte
            const lines = logInput.split('\n');
            
            // Firebase-Initialisierung
            const firebaseLines = lines.filter(line => line.includes('FIREBASE'));
            analysis += `üî• FIREBASE (${firebaseLines.length} Eintr√§ge):\n`;
            
            if (firebaseLines.some(line => line.includes('erfolgreich initialisiert'))) {
                analysis += '‚úÖ Firebase erfolgreich initialisiert\n';
            } else {
                analysis += '‚ùå Firebase-Initialisierung problematisch\n';
            }
            
            // Auth-System
            const authLines = lines.filter(line => line.includes('AUTH'));
            analysis += `\nüë§ AUTH (${authLines.length} Eintr√§ge):\n`;
            
            if (authLines.some(line => line.includes('erfolgreich initialisiert'))) {
                analysis += '‚úÖ Auth-System erfolgreich initialisiert\n';
            }
            
            if (authLines.some(line => line.includes('Login-Versuch'))) {
                analysis += '‚úÖ Login-Versuch erkannt\n';
            }
            
            if (authLines.some(line => line.includes('Auth State Change'))) {
                analysis += '‚úÖ Auth-State-Changes erkannt\n';
            }
            
            // Redirect-Probleme
            const redirectLines = lines.filter(line => 
                line.includes('Weiterleitung') || 
                line.includes('redirect') || 
                line.includes('Dashboard') ||
                line.includes('admin-login')
            );
            analysis += `\nüîÑ REDIRECTS (${redirectLines.length} Eintr√§ge):\n`;
            
            if (redirectLines.length > 5) {
                analysis += '‚ö†Ô∏è Viele Redirect-Aktivit√§ten - m√∂glicher Loop\n';
            }
            
            // Fehler analysieren
            const errorLines = lines.filter(line => 
                line.includes('ERROR') || 
                line.includes('‚ùå') || 
                line.includes('error') ||
                line.includes('Error')
            );
            analysis += `\n‚ùå FEHLER (${errorLines.length} Eintr√§ge):\n`;
            
            if (errorLines.length === 0) {
                analysis += '‚úÖ Keine Fehler gefunden\n';
            } else {
                // H√§ufigste Fehler identifizieren
                const permissionErrors = errorLines.filter(line => line.includes('permission'));
                const authErrors = errorLines.filter(line => line.includes('auth'));
                const firebaseErrors = errorLines.filter(line => line.includes('firebase'));
                
                if (permissionErrors.length > 0) {
                    analysis += `üîí ${permissionErrors.length} Berechtigungsfehler\n`;
                }
                if (authErrors.length > 0) {
                    analysis += `üë§ ${authErrors.length} Auth-Fehler\n`;
                }
                if (firebaseErrors.length > 0) {
                    analysis += `üî• ${firebaseErrors.length} Firebase-Fehler\n`;
                }
            }
            
            // Spezifische Probleme suchen
            analysis += `\nüéØ SPEZIFISCHE PROBLEME:\n`;
            
            if (logInput.includes('Missing or insufficient permissions')) {
                analysis += 'üîí Firestore-Berechtigungsfehler erkannt\n';
                analysis += '   ‚Üí L√∂sung: Firestore-Regeln aktualisieren\n';
            }
            
            if (logInput.includes('Redirect-Loop') || redirectLines.length > 10) {
                analysis += 'üîÑ Redirect-Loop erkannt\n';
                analysis += '   ‚Üí L√∂sung: NoRedirect-Modus verwenden\n';
            }
            
            if (logInput.includes('t.o@trend4media.de')) {
                analysis += 'üë§ Admin-Benutzer-Aktivit√§t erkannt\n';
                
                if (logInput.includes('Login-Versuch') && logInput.includes('Weiterleitung')) {
                    analysis += '   ‚Üí Login erfolgreich, aber Redirect-Problem\n';
                } else if (logInput.includes('Login-Versuch')) {
                    analysis += '   ‚Üí Login-Versuch erkannt\n';
                }
            }
            
            if (logInput.includes('isSuperAdmin')) {
                analysis += 'üõ°Ô∏è Super-Admin-Checks erkannt\n';
                
                if (logInput.includes('isSuperAdmin: false') || logInput.includes('isSuperAdmin: undefined')) {
                    analysis += '   ‚ùå isSuperAdmin nicht korrekt gesetzt\n';
                    analysis += '   ‚Üí L√∂sung: UserData-Struktur reparieren\n';
                } else if (logInput.includes('isSuperAdmin: true')) {
                    analysis += '   ‚úÖ isSuperAdmin korrekt gesetzt\n';
                }
            }
            
            // Empfehlungen
            analysis += `\nüí° EMPFEHLUNGEN:\n`;
            
            if (permissionErrors.length > 5) {
                analysis += '1. Firestore-Regeln aktualisieren (KRITISCH)\n';
            }
            
            if (redirectLines.length > 10) {
                analysis += '2. NoRedirect-Modus verwenden: ?noredirect=true\n';
            }
            
            if (errorLines.length > 20) {
                analysis += '3. Browser-Cache leeren (Hard-Refresh)\n';
            }
            
            analysis += '\nüîó N√ºtzliche Links:\n';
            analysis += '‚Ä¢ Firebase Console: https://console.firebase.google.com/project/spacenations-tools\n';
            analysis += '‚Ä¢ Firestore Rules: https://console.firebase.google.com/project/spacenations-tools/firestore/rules\n';
            analysis += '‚Ä¢ Auth Users: https://console.firebase.google.com/project/spacenations-tools/authentication/users\n';
            
            analysisOutput.textContent = analysis;
        }
        
        // System-Status pr√ºfen
        async function checkSystemStatus() {
            const statusOutput = document.getElementById('status-output');
            
            let status = 'üìä AKTUELLER SYSTEM-STATUS:\n\n';
            
            try {
                // Firebase-Status
                status += 'üî• FIREBASE:\n';
                if (window.FirebaseConfig) {
                    status += `‚Ä¢ FirebaseConfig: ‚úÖ\n`;
                    status += `‚Ä¢ Bereit: ${window.FirebaseConfig.isReady() ? '‚úÖ' : '‚ùå'}\n`;
                    status += `‚Ä¢ Offline: ${window.FirebaseConfig.isOffline() ? '‚ùå' : '‚úÖ'}\n`;
                    
                    const auth = window.FirebaseConfig.getAuth();
                    const db = window.FirebaseConfig.getDB();
                    status += `‚Ä¢ Auth Service: ${auth ? '‚úÖ' : '‚ùå'}\n`;
                    status += `‚Ä¢ DB Service: ${db ? '‚úÖ' : '‚ùå'}\n`;
                } else {
                    status += '‚ùå FirebaseConfig nicht verf√ºgbar\n';
                }
                
                // Auth-Status
                status += '\nüë§ AUTH:\n';
                if (window.AuthAPI) {
                    status += `‚Ä¢ AuthAPI: ‚úÖ\n`;
                    status += `‚Ä¢ Initialisiert: ${window.AuthAPI.isInitialized() ? '‚úÖ' : '‚ùå'}\n`;
                    status += `‚Ä¢ Angemeldet: ${window.AuthAPI.isLoggedIn() ? '‚úÖ' : '‚ùå'}\n`;
                    
                    const currentUser = window.AuthAPI.getCurrentUser();
                    const userData = window.AuthAPI.getUserData();
                    
                    if (currentUser) {
                        status += `‚Ä¢ User: ${currentUser.email}\n`;
                        status += `‚Ä¢ UID: ${currentUser.uid}\n`;
                        status += `‚Ä¢ UserData: ${userData ? '‚úÖ' : '‚ùå'}\n`;
                        
                        if (userData) {
                            status += `‚Ä¢ isSuperAdmin: ${userData.isSuperAdmin} (${typeof userData.isSuperAdmin})\n`;
                            status += `‚Ä¢ systemRole: ${userData.systemRole}\n`;
                            status += `‚Ä¢ source: ${userData.source}\n`;
                        }
                    }
                } else {
                    status += '‚ùå AuthAPI nicht verf√ºgbar\n';
                }
                
                // FirebaseSync-Status
                status += '\nüîÑ FIREBASE-SYNC:\n';
                if (window.firebaseSync) {
                    status += `‚Ä¢ FirebaseSync: ‚úÖ\n`;
                    status += `‚Ä¢ Aktuelle Seite: ${window.firebaseSync.currentPage}\n`;
                } else {
                    status += '‚ùå FirebaseSync nicht verf√ºgbar\n';
                }
                
                // Analytics-Status
                status += '\nüìä ANALYTICS:\n';
                if (window.analyticsTracker) {
                    const analyticsStatus = window.analyticsTracker.getStatus();
                    status += `‚Ä¢ Analytics Tracker: ‚úÖ\n`;
                    status += `‚Ä¢ Initialisiert: ${analyticsStatus.initialized ? '‚úÖ' : '‚ùå'}\n`;
                    status += `‚Ä¢ Firebase-Modus: ${analyticsStatus.firebaseReady ? '‚úÖ' : '‚ùå (Lokal)'}\n`;
                    status += `‚Ä¢ Berechtigungen: ${analyticsStatus.permissionsDenied ? '‚ùå' : '‚úÖ'}\n`;
                } else {
                    status += '‚ùå Analytics Tracker nicht verf√ºgbar\n';
                }
                
                // Logger-System
                status += '\nüìã LOGGER:\n';
                if (window.log) {
                    status += `‚Ä¢ Logger-System: ‚úÖ\n`;
                    
                    // Versuche Logs abzurufen
                    if (typeof getLogs === 'function') {
                        try {
                            const recentLogs = getLogs({recent: 10});
                            status += `‚Ä¢ Verf√ºgbare Logs: ${recentLogs.length}\n`;
                        } catch (logError) {
                            status += `‚Ä¢ Log-Abruf: ‚ùå ${logError.message}\n`;
                        }
                    }
                } else {
                    status += '‚ùå Logger-System nicht verf√ºgbar\n';
                }
                
                // Zusammenfassung
                status += '\nüéØ ZUSAMMENFASSUNG:\n';
                const firebaseOK = window.FirebaseConfig?.isReady();
                const authOK = window.AuthAPI?.isInitialized();
                const userLoggedIn = window.AuthAPI?.isLoggedIn();
                const userDataOK = window.AuthAPI?.getUserData()?.isSuperAdmin === true;
                
                if (firebaseOK && authOK && userLoggedIn && userDataOK) {
                    status += '‚úÖ System vollst√§ndig funktionsf√§hig\n';
                    status += 'üöÄ Admin-Dashboard sollte zug√§nglich sein\n';
                } else {
                    status += '‚ö†Ô∏è System hat Probleme:\n';
                    if (!firebaseOK) status += '   - Firebase nicht bereit\n';
                    if (!authOK) status += '   - Auth-System nicht bereit\n';
                    if (!userLoggedIn) status += '   - Benutzer nicht angemeldet\n';
                    if (!userDataOK) status += '   - UserData/Super-Admin-Status problematisch\n';
                }
                
            } catch (error) {
                status += `\n‚ùå Status-Check-Fehler: ${error.message}\n`;
            }
            
            statusOutput.textContent = status;
        }
        
        // Browser-Logs l√∂schen
        function clearAllLogs() {
            if (typeof clearLogs === 'function') {
                clearLogs();
                console.clear();
                alert('‚úÖ Logs gel√∂scht');
            } else {
                console.clear();
                alert('‚úÖ Browser-Konsole geleert');
            }
        }
        
        // Logs exportieren
        function exportLogs() {
            const logInput = document.getElementById('log-input').value;
            
            if (!logInput.trim()) {
                alert('Keine Logs zum Exportieren vorhanden');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `spacenations-logs-${timestamp}.txt`;
            
            const blob = new Blob([logInput], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Logs exportiert als: ${filename}`);
        }
        
        // Auto-Status-Check beim Laden
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Warte kurz und pr√ºfe dann System-Status
                setTimeout(() => {
                    checkSystemStatus();
                }, 2000);
                
            } catch (error) {
                console.error('Auto-status-check failed:', error);
            }
        });
    </script>
</body>
</html>