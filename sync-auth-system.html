<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth System Sync - Spacenations Tools</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0A0A0A;
            color: #FFFFFF;
            padding: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1A1A1A;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00FF88;
        }
        
        h1 {
            color: #00FF88;
            margin-bottom: 30px;
        }
        
        .btn {
            background: #00FF88;
            color: #000000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn:hover {
            background: #44FF99;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.danger {
            background: #F44336;
            color: #FFFFFF;
        }
        
        .btn.danger:hover {
            background: #E57373;
        }
        
        .btn.warning {
            background: #FF9800;
            color: #000000;
        }
        
        .btn.warning:hover {
            background: #FFB74D;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: left;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid #F44336;
        }
        
        .info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
            border: 1px solid #2196F3;
        }
        
        .warning {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
            border: 1px solid #FF9800;
        }
        
        .user-list {
            background: #2A2A2A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00FF88;
        }
        
        .user-item.firestore-only {
            border-left-color: #FF9800;
        }
        
        .user-item.auth-only {
            border-left-color: #F44336;
        }
        
        .user-item.synced {
            border-left-color: #4CAF50;
        }
        
        .user-item h4 {
            margin: 0 0 10px 0;
            color: #00FF88;
        }
        
        .user-item p {
            margin: 5px 0;
            color: #CCC;
        }
        
        .sync-options {
            background: #2A2A2A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .sync-options h3 {
            color: #00FF88;
            margin-bottom: 15px;
        }
        
        .sync-options ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .sync-options li {
            margin: 5px 0;
            color: #CCC;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #00FF88;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Auth System Synchronisation</h1>
        <p>Synchronisiere Firestore User mit Firebase Authentication</p>
        
        <div class="sync-options">
            <h3>üîß Synchronisations-Optionen:</h3>
            <ul>
                <li><strong>Firestore ‚Üí Auth:</strong> Erstellt Firebase Auth Accounts f√ºr Firestore User</li>
                <li><strong>Auth ‚Üí Firestore:</strong> Erstellt Firestore Dokumente f√ºr Auth User</li>
                <li><strong>Vollst√§ndige Sync:</strong> Synchronisiert beide Richtungen</li>
                <li><strong>Passwort-Reset:</strong> Setzt Passw√∂rter f√ºr alle User zur√ºck</li>
            </ul>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progress-text">Bereite Synchronisation vor...</p>
        </div>
        
        <div id="user-list" class="user-list" style="display: none;">
            <h3>üë• Gefundene User:</h3>
            <div id="user-items"></div>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="btn" onclick="analyzeUsers()">üîç User analysieren</button>
            <button class="btn warning" onclick="syncFirestoreToAuth()" id="sync-firestore-btn" style="display: none;">üì§ Firestore ‚Üí Auth</button>
            <button class="btn warning" onclick="syncAuthToFirestore()" id="sync-auth-btn" style="display: none;">üì• Auth ‚Üí Firestore</button>
            <button class="btn" onclick="fullSync()" id="full-sync-btn" style="display: none;">üîÑ Vollst√§ndige Sync</button>
            <button class="btn danger" onclick="resetAllPasswords()" id="reset-passwords-btn" style="display: none;">üîë Passw√∂rter zur√ºcksetzen</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: 'AIzaSyDr4-ap_EubUn0UdP7hkEpS2jkzLIVgvyc',
            authDomain: 'spacenations-tools.firebaseapp.com',
            projectId: 'spacenations-tools',
            storageBucket: 'spacenations-tools.firebasestorage.app',
            messagingSenderId: '651338201276',
            appId: '1:651338201276:web:89e7d9c19dbd2611d3f8b9',
            measurementId: 'G-SKWJWH2ERX'
        };
        
        // Firebase initialisieren
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let userAnalysis = {
            firestoreUsers: [],
            authUsers: [],
            syncedUsers: [],
            firestoreOnly: [],
            authOnly: []
        };
        
        async function analyzeUsers() {
            try {
                showStatus('Analysiere User in Firestore und Firebase Auth...', 'info');
                showProgress(true);
                updateProgress(10, 'Lade Firestore User...');
                
                // Lade Firestore User
                const firestoreSnapshot = await db.collection('users').get();
                userAnalysis.firestoreUsers = firestoreSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateProgress(50, 'Lade Firebase Auth User...');
                
                // Lade Firebase Auth User
                const authUsers = await auth.listUsers();
                userAnalysis.authUsers = authUsers.users.map(user => ({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    emailVerified: user.emailVerified,
                    disabled: user.disabled
                }));
                
                updateProgress(80, 'Analysiere Synchronisation...');
                
                // Analysiere Synchronisation
                analyzeSyncStatus();
                
                updateProgress(100, 'Analyse abgeschlossen');
                
                displayUserAnalysis();
                showStatus(`Analyse abgeschlossen: ${userAnalysis.firestoreUsers.length} Firestore, ${userAnalysis.authUsers.length} Auth`, 'success');
                
                // Zeige Sync-Buttons
                document.getElementById('sync-firestore-btn').style.display = 'inline-block';
                document.getElementById('sync-auth-btn').style.display = 'inline-block';
                document.getElementById('full-sync-btn').style.display = 'inline-block';
                document.getElementById('reset-passwords-btn').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Fehler bei der Analyse:', error);
                showStatus('Fehler bei der Analyse: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        function analyzeSyncStatus() {
            userAnalysis.syncedUsers = [];
            userAnalysis.firestoreOnly = [];
            userAnalysis.authOnly = [];
            
            // Pr√ºfe Firestore User
            userAnalysis.firestoreUsers.forEach(firestoreUser => {
                const authUser = userAnalysis.authUsers.find(authUser => 
                    authUser.email === firestoreUser.email
                );
                
                if (authUser) {
                    userAnalysis.syncedUsers.push({
                        ...firestoreUser,
                        authUid: authUser.uid,
                        authUser: authUser
                    });
                } else {
                    userAnalysis.firestoreOnly.push(firestoreUser);
                }
            });
            
            // Pr√ºfe Auth User
            userAnalysis.authUsers.forEach(authUser => {
                const firestoreUser = userAnalysis.firestoreUsers.find(firestoreUser => 
                    firestoreUser.email === authUser.email
                );
                
                if (!firestoreUser) {
                    userAnalysis.authOnly.push(authUser);
                }
            });
        }
        
        function displayUserAnalysis() {
            const userList = document.getElementById('user-list');
            const userItems = document.getElementById('user-items');
            
            userList.style.display = 'block';
            
            let html = '';
            
            // Synced Users
            if (userAnalysis.syncedUsers.length > 0) {
                html += '<h4 style="color: #4CAF50;">‚úÖ Synchronisierte User:</h4>';
                userAnalysis.syncedUsers.forEach(user => {
                    html += createUserItem(user, 'synced');
                });
            }
            
            // Firestore Only
            if (userAnalysis.firestoreOnly.length > 0) {
                html += '<h4 style="color: #FF9800;">‚ö†Ô∏è Nur in Firestore:</h4>';
                userAnalysis.firestoreOnly.forEach(user => {
                    html += createUserItem(user, 'firestore-only');
                });
            }
            
            // Auth Only
            if (userAnalysis.authOnly.length > 0) {
                html += '<h4 style="color: #F44336;">‚ùå Nur in Firebase Auth:</h4>';
                userAnalysis.authOnly.forEach(user => {
                    html += createUserItem(user, 'auth-only');
                });
            }
            
            userItems.innerHTML = html;
        }
        
        function createUserItem(user, type) {
            const isFirestore = 'username' in user;
            const isAuth = 'uid' in user;
            
            return `
                <div class="user-item ${type}">
                    <h4>${isFirestore ? user.username : user.email}</h4>
                    <p><strong>E-Mail:</strong> ${isFirestore ? user.email : user.email}</p>
                    ${isFirestore ? `<p><strong>Rolle:</strong> ${user.systemRole || 'Unbekannt'}</p>` : ''}
                    ${isAuth ? `<p><strong>UID:</strong> ${user.uid}</p>` : ''}
                    ${isAuth ? `<p><strong>Verifiziert:</strong> ${user.emailVerified ? 'Ja' : 'Nein'}</p>` : ''}
                    <p><strong>Status:</strong> ${type === 'synced' ? 'Synchronisiert' : type === 'firestore-only' ? 'Nur Firestore' : 'Nur Auth'}</p>
                </div>
            `;
        }
        
        async function syncFirestoreToAuth() {
            if (userAnalysis.firestoreOnly.length === 0) {
                showStatus('Keine Firestore-User zum Synchronisieren gefunden!', 'warning');
                return;
            }
            
            if (!confirm(`${userAnalysis.firestoreOnly.length} User von Firestore zu Firebase Auth synchronisieren?`)) {
                return;
            }
            
            try {
                showStatus('Synchronisiere Firestore ‚Üí Firebase Auth...', 'info');
                showProgress(true);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < userAnalysis.firestoreOnly.length; i++) {
                    const user = userAnalysis.firestoreOnly[i];
                    const progress = Math.round(((i + 1) / userAnalysis.firestoreOnly.length) * 100);
                    
                    try {
                        updateProgress(progress, `Erstelle Auth Account f√ºr ${user.username}...`);
                        
                        // Erstelle Firebase Auth Account
                        const userCredential = await auth.createUserWithEmailAndPassword(
                            user.email, 
                            user.password ? atob(user.password) : 'defaultPassword123'
                        );
                        
                        // Aktualisiere Firestore User mit Auth UID
                        await db.collection('users').doc(user.id).update({
                            authUid: userCredential.user.uid,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        successCount++;
                        
                    } catch (error) {
                        console.error(`Fehler bei User ${user.username}:`, error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'Synchronisation abgeschlossen');
                showStatus(`Firestore ‚Üí Auth Sync abgeschlossen: ${successCount} erfolgreich, ${errorCount} Fehler`, 'success');
                
                // Neu analysieren
                setTimeout(() => {
                    analyzeUsers();
                }, 2000);
                
            } catch (error) {
                console.error('Fehler bei der Synchronisation:', error);
                showStatus('Fehler bei der Synchronisation: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        async function syncAuthToFirestore() {
            if (userAnalysis.authOnly.length === 0) {
                showStatus('Keine Auth-User zum Synchronisieren gefunden!', 'warning');
                return;
            }
            
            if (!confirm(`${userAnalysis.authOnly.length} User von Firebase Auth zu Firestore synchronisieren?`)) {
                return;
            }
            
            try {
                showStatus('Synchronisiere Firebase Auth ‚Üí Firestore...', 'info');
                showProgress(true);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < userAnalysis.authOnly.length; i++) {
                    const user = userAnalysis.authOnly[i];
                    const progress = Math.round(((i + 1) / userAnalysis.authOnly.length) * 100);
                    
                    try {
                        updateProgress(progress, `Erstelle Firestore Dokument f√ºr ${user.email}...`);
                        
                        // Erstelle Firestore User Dokument
                        const userData = {
                            username: user.email.split('@')[0],
                            email: user.email,
                            password: btoa('defaultPassword123'),
                            systemRole: 'user',
                            alliance: null,
                            allianceRole: null,
                            isActive: true,
                            loginCount: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: 'auth-sync',
                            permissions: {
                                dashboard_access: true,
                                profile_edit: true
                            },
                            profile: {
                                displayName: user.displayName || user.email.split('@')[0],
                                bio: 'User aus Firebase Auth synchronisiert',
                                avatar: null
                            },
                            authUid: user.uid
                        };
                        
                        await db.collection('users').doc(userData.username).set(userData);
                        
                        successCount++;
                        
                    } catch (error) {
                        console.error(`Fehler bei User ${user.email}:`, error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'Synchronisation abgeschlossen');
                showStatus(`Auth ‚Üí Firestore Sync abgeschlossen: ${successCount} erfolgreich, ${errorCount} Fehler`, 'success');
                
                // Neu analysieren
                setTimeout(() => {
                    analyzeUsers();
                }, 2000);
                
            } catch (error) {
                console.error('Fehler bei der Synchronisation:', error);
                showStatus('Fehler bei der Synchronisation: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        async function fullSync() {
            if (!confirm('Vollst√§ndige Synchronisation in beide Richtungen durchf√ºhren?')) {
                return;
            }
            
            try {
                showStatus('Starte vollst√§ndige Synchronisation...', 'info');
                
                // Erst Firestore ‚Üí Auth
                if (userAnalysis.firestoreOnly.length > 0) {
                    await syncFirestoreToAuth();
                }
                
                // Dann Auth ‚Üí Firestore
                if (userAnalysis.authOnly.length > 0) {
                    await syncAuthToFirestore();
                }
                
                showStatus('Vollst√§ndige Synchronisation abgeschlossen!', 'success');
                
            } catch (error) {
                console.error('Fehler bei der vollst√§ndigen Synchronisation:', error);
                showStatus('Fehler bei der vollst√§ndigen Synchronisation: ' + error.message, 'error');
            }
        }
        
        async function resetAllPasswords() {
            if (!confirm('ALLE Passw√∂rter auf "defaultPassword123" zur√ºcksetzen?')) {
                return;
            }
            
            try {
                showStatus('Setze alle Passw√∂rter zur√ºck...', 'warning');
                showProgress(true);
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < userAnalysis.syncedUsers.length; i++) {
                    const user = userAnalysis.syncedUsers[i];
                    const progress = Math.round(((i + 1) / userAnalysis.syncedUsers.length) * 100);
                    
                    try {
                        updateProgress(progress, `Setze Passwort f√ºr ${user.username} zur√ºck...`);
                        
                        // Aktualisiere Passwort in Firestore
                        await db.collection('users').doc(user.id).update({
                            password: btoa('defaultPassword123'),
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Aktualisiere Passwort in Firebase Auth
                        if (user.authUid) {
                            await auth.updateUser(user.authUid, {
                                password: 'defaultPassword123'
                            });
                        }
                        
                        successCount++;
                        
                    } catch (error) {
                        console.error(`Fehler bei User ${user.username}:`, error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'Passwort-Reset abgeschlossen');
                showStatus(`Passwort-Reset abgeschlossen: ${successCount} erfolgreich, ${errorCount} Fehler`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Passwort-Reset:', error);
                showStatus('Fehler beim Passwort-Reset: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }
        
        function showProgress(show) {
            document.getElementById('progress-container').style.display = show ? 'block' : 'none';
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // Nach 10 Sekunden ausblenden
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 10000);
        }
        
        // Beim Laden der Seite User analysieren
        document.addEventListener('DOMContentLoaded', () => {
            analyzeUsers();
        });
    </script>
</body>
</html>