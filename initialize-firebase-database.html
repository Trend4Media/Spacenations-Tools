<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Datenbank Initialisierung</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .section { 
            background: #2a2a2a; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 1px solid #444; 
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 10px 5px; 
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            background: #333; 
        }
        pre { 
            background: #000; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto; 
            white-space: pre-wrap;
        }
        .step {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üóÑÔ∏è Firebase Datenbank Initialisierung</h1>
    <p>Dieses Tool erstellt die notwendigen Collections f√ºr das Allianz-System in deiner Firebase-Datenbank.</p>
    
    <div class="section">
        <h2>üìã Was wird erstellt:</h2>
        <div class="step">
            <strong>1. alliances Collection</strong><br>
            Speichert alle Allianz-Informationen (Name, Tag, Mitglieder, Status, etc.)
        </div>
        <div class="step">
            <strong>2. alliancePermissions Collection</strong><br>
            Speichert Allianz-weite Berechtigungen
        </div>
        <div class="step">
            <strong>3. allianceChats Collection</strong><br>
            Speichert Chat-Nachrichten f√ºr jede Allianz
        </div>
        <div class="step">
            <strong>4. allianceActivities Collection</strong><br>
            Loggt alle Allianz-Aktivit√§ten
        </div>
    </div>
    
    <div class="section">
        <h2>üîß Initialisierung</h2>
        <div id="init-status" class="status">Bereit f√ºr Initialisierung...</div>
        <button onclick="initializeDatabase()" id="init-btn">Datenbank initialisieren</button>
        <button onclick="checkDatabase()" id="check-btn">Status pr√ºfen</button>
        <button onclick="createTestData()" id="test-btn">Test-Daten erstellen</button>
    </div>
    
    <div class="section">
        <h2>üìä Aktueller Status</h2>
        <div id="database-status">Wird gepr√ºft...</div>
    </div>
    
    <div class="section">
        <h2>üìù Logs</h2>
        <button onclick="clearLogs()">Logs l√∂schen</button>
        <pre id="logs"></pre>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    
    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logsElement = document.getElementById('logs');
            logsElement.textContent = logs.join('\n');
            logsElement.scrollTop = logsElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').textContent = '';
        }
        
        async function checkDatabase() {
            log('Pr√ºfe Datenbank-Status...');
            const statusDiv = document.getElementById('database-status');
            
            try {
                await window.FirebaseConfig.waitForInit();
                const db = window.FirebaseConfig.getDB();
                
                const collections = [
                    'alliances',
                    'alliancePermissions', 
                    'allianceChats',
                    'allianceActivities'
                ];
                
                let status = '<h3>Collection Status:</h3><ul>';
                
                for (const collectionName of collections) {
                    try {
                        const snapshot = await db.collection(collectionName).limit(1).get();
                        const count = snapshot.size;
                        status += `<li class="success">‚úÖ ${collectionName} - ${count} Dokumente</li>`;
                        log(`Collection ${collectionName}: ${count} Dokumente`);
                    } catch (error) {
                        status += `<li class="error">‚ùå ${collectionName} - Fehler: ${error.message}</li>`;
                        log(`Fehler bei ${collectionName}: ${error.message}`, 'error');
                    }
                }
                
                status += '</ul>';
                statusDiv.innerHTML = status;
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">‚ùå Fehler: ${error.message}</span>`;
                log(`Datenbank-Pr√ºfung fehlgeschlagen: ${error.message}`, 'error');
            }
        }
        
        async function initializeDatabase() {
            const statusDiv = document.getElementById('init-status');
            const initBtn = document.getElementById('init-btn');
            
            initBtn.disabled = true;
            initBtn.textContent = 'Initialisiere...';
            statusDiv.innerHTML = 'Initialisierung l√§uft...';
            
            try {
                log('Starte Datenbank-Initialisierung...');
                await window.FirebaseConfig.waitForInit();
                const db = window.FirebaseConfig.getDB();
                
                // 1. Erstelle Test-Dokumente f√ºr jede Collection
                log('Erstelle Test-Dokumente...');
                
                // alliances Collection
                const testAlliance = {
                    name: 'Test Allianz',
                    tag: 'TEST',
                    description: 'Test-Allianz f√ºr Initialisierung',
                    founder: 'system',
                    members: ['system'],
                    status: 'approved',
                    admin: 'system',
                    createdAt: window.FirebaseConfig.getServerTimestamp()
                };
                
                const allianceRef = await db.collection('alliances').add(testAlliance);
                log(`Alliances Collection erstellt - Test-Dokument ID: ${allianceRef.id}`);
                
                // alliancePermissions Collection
                const testPermissions = {
                    chat_read: { enabled: true, description: "Chat lesen" },
                    chat_write: { enabled: true, description: "Chat schreiben" },
                    spy_database: { enabled: false, description: "Spionage-Datenbank" },
                    member_approval: { enabled: false, description: "Mitglieder best√§tigen" },
                    permission_manage: { enabled: false, description: "Berechtigungen verwalten" }
                };
                
                await db.collection('alliancePermissions').doc(allianceRef.id).set(testPermissions);
                log('AlliancePermissions Collection erstellt');
                
                // allianceChats Collection (mit Subcollection)
                const testMessage = {
                    content: 'Willkommen in der Test-Allianz!',
                    author: 'system',
                    timestamp: window.FirebaseConfig.getServerTimestamp(),
                    allianceId: allianceRef.id
                };
                
                await db.collection('allianceChats').doc(allianceRef.id).collection('messages').add(testMessage);
                log('AllianceChats Collection erstellt');
                
                // allianceActivities Collection
                const testActivity = {
                    allianceId: allianceRef.id,
                    type: 'alliance_created',
                    member: 'system',
                    performedBy: 'system',
                    timestamp: window.FirebaseConfig.getServerTimestamp(),
                    details: { message: 'Test-Allianz erstellt' }
                };
                
                await db.collection('allianceActivities').add(testActivity);
                log('AllianceActivities Collection erstellt');
                
                // L√∂sche Test-Dokumente wieder
                log('L√∂sche Test-Dokumente...');
                await allianceRef.delete();
                await db.collection('alliancePermissions').doc(allianceRef.id).delete();
                await db.collection('allianceChats').doc(allianceRef.id).collection('messages').get().then(snapshot => {
                    snapshot.forEach(doc => doc.ref.delete());
                });
                await db.collection('allianceChats').doc(allianceRef.id).delete();
                
                // L√∂sche Test-Aktivit√§t
                const activitiesSnapshot = await db.collection('allianceActivities')
                    .where('allianceId', '==', allianceRef.id)
                    .get();
                activitiesSnapshot.forEach(doc => doc.ref.delete());
                
                log('Test-Dokumente gel√∂scht');
                
                statusDiv.innerHTML = '<span class="success">‚úÖ Datenbank erfolgreich initialisiert!</span>';
                log('Datenbank-Initialisierung abgeschlossen', 'success');
                
                // Aktualisiere Status
                await checkDatabase();
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">‚ùå Fehler: ${error.message}</span>`;
                log(`Initialisierung fehlgeschlagen: ${error.message}`, 'error');
            } finally {
                initBtn.disabled = false;
                initBtn.textContent = 'Datenbank initialisieren';
            }
        }
        
        async function createTestData() {
            const testBtn = document.getElementById('test-btn');
            testBtn.disabled = true;
            testBtn.textContent = 'Erstelle...';
            
            try {
                log('Erstelle Test-Daten...');
                await window.FirebaseConfig.waitForInit();
                const db = window.FirebaseConfig.getDB();
                
                // Erstelle mehrere Test-Allianzen
                const testAlliances = [
                    {
                        name: 'Space Warriors',
                        tag: 'SW',
                        description: 'Eine starke Allianz f√ºr erfahrene Spieler',
                        founder: 'testuser1',
                        members: ['testuser1'],
                        status: 'pending',
                        admin: null,
                        createdAt: window.FirebaseConfig.getServerTimestamp()
                    },
                    {
                        name: 'Galactic Empire',
                        tag: 'GE',
                        description: 'Herrschaft √ºber die Galaxie',
                        founder: 'testuser2',
                        members: ['testuser2'],
                        status: 'approved',
                        admin: 'testuser2',
                        createdAt: window.FirebaseConfig.getServerTimestamp(),
                        approvedAt: window.FirebaseConfig.getServerTimestamp()
                    }
                ];
                
                for (const alliance of testAlliances) {
                    const docRef = await db.collection('alliances').add(alliance);
                    log(`Test-Allianz erstellt: ${alliance.name} (ID: ${docRef.id})`);
                    
                    // Erstelle Berechtigungen
                    await db.collection('alliancePermissions').doc(docRef.id).set({
                        chat_read: { enabled: true, description: "Chat lesen" },
                        chat_write: { enabled: true, description: "Chat schreiben" },
                        spy_database: { enabled: false, description: "Spionage-Datenbank" },
                        member_approval: { enabled: false, description: "Mitglieder best√§tigen" },
                        permission_manage: { enabled: false, description: "Berechtigungen verwalten" }
                    });
                }
                
                log('Test-Daten erfolgreich erstellt', 'success');
                await checkDatabase();
                
            } catch (error) {
                log(`Fehler beim Erstellen der Test-Daten: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test-Daten erstellen';
            }
        }
        
        // Auto-Check beim Laden
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkDatabase, 1000);
        });
    </script>
</body>
</html>