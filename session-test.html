<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Test - Spacenations Tools</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #00FF88;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #b0b0b0;
            font-size: 1.1rem;
        }
        
        .test-section {
            background: rgba(0,0,0,0.8);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .test-section h2 {
            color: #00FF88;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .test-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .test-item h3 {
            color: #ff8c42;
            margin-bottom: 10px;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .test-result.success {
            background: rgba(34,197,94,0.1);
            border: 1px solid #22c55e;
            color: #22c55e;
        }
        
        .test-result.error {
            background: rgba(239,68,68,0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
        }
        
        .test-result.info {
            background: rgba(59,130,246,0.1);
            border: 1px solid #3b82f6;
            color: #3b82f6;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .btn.primary {
            background: linear-gradient(135deg, #00FF88, #44FF99);
            color: #000;
        }
        
        .btn.primary:hover {
            background: linear-gradient(135deg, #44FF99, #88FFBB);
            transform: translateY(-2px);
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #3a5998, #4a90e2);
            color: white;
        }
        
        .btn.secondary:hover {
            background: linear-gradient(135deg, #4a90e2, #5ba0f2);
            transform: translateY(-2px);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .btn.danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(0,0,0,0.3);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .status-card.active {
            border-color: #00FF88;
        }
        
        .status-card.warning {
            border-color: #ff8c42;
        }
        
        .status-card.error {
            border-color: #ef4444;
        }
        
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-value.success {
            color: #00FF88;
        }
        
        .status-value.warning {
            color: #ff8c42;
        }
        
        .status-value.error {
            color: #ef4444;
        }
        
        .json-display {
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Session System Test</h1>
            <p>Vollst√§ndige Tests des User Session Systems</p>
        </div>
        
        <!-- Status Overview -->
        <div class="status-grid">
            <div class="status-card" id="session-status-card">
                <h3>Session Status</h3>
                <div class="status-value" id="session-status">‚ùì</div>
                <p id="session-details">Pr√ºfe...</p>
            </div>
            
            <div class="status-card" id="auth-status-card">
                <h3>Auth Status</h3>
                <div class="status-value" id="auth-status">‚ùì</div>
                <p id="auth-details">Pr√ºfe...</p>
            </div>
            
            <div class="status-card" id="storage-status-card">
                <h3>Storage Status</h3>
                <div class="status-value" id="storage-status">‚ùì</div>
                <p id="storage-details">Pr√ºfe...</p>
            </div>
        </div>
        
        <!-- Test Buttons -->
        <div class="test-section">
            <h2>üîß Test Controls</h2>
            <button class="btn primary" onclick="runAllTests()">üöÄ Alle Tests ausf√ºhren</button>
            <button class="btn secondary" onclick="testSessionAPI()">üì± SessionAPI Test</button>
            <button class="btn secondary" onclick="testAuthAPI()">üîê AuthAPI Test</button>
            <button class="btn secondary" onclick="testStorage()">üíæ Storage Test</button>
            <button class="btn danger" onclick="clearAllData()">üóëÔ∏è Alle Daten l√∂schen</button>
            <button class="btn secondary" onclick="exportSessionData()">üì§ Session exportieren</button>
        </div>
        
        <!-- SessionAPI Tests -->
        <div class="test-section">
            <h2>üì± SessionAPI Tests</h2>
            <div class="test-item">
                <h3>SessionAPI Verf√ºgbarkeit</h3>
                <div id="sessionapi-test" class="test-result">Warte auf Test...</div>
            </div>
            
            <div class="test-item">
                <h3>User-Daten</h3>
                <div id="userdata-test" class="test-result">Warte auf Test...</div>
            </div>
            
            <div class="test-item">
                <h3>Session-Status</h3>
                <div id="sessionstatus-test" class="test-result">Warte auf Test...</div>
            </div>
        </div>
        
        <!-- AuthAPI Tests -->
        <div class="test-section">
            <h2>üîê AuthAPI Tests</h2>
            <div class="test-item">
                <h3>AuthAPI Verf√ºgbarkeit</h3>
                <div id="authapi-test" class="test-result">Warte auf Test...</div>
            </div>
            
            <div class="test-item">
                <h3>Current User</h3>
                <div id="currentuser-test" class="test-result">Warte auf Test...</div>
            </div>
            
            <div class="test-item">
                <h3>Auth State</h3>
                <div id="authstate-test" class="test-result">Warte auf Test...</div>
            </div>
        </div>
        
        <!-- Storage Tests -->
        <div class="test-section">
            <h2>üíæ Storage Tests</h2>
            <div class="test-item">
                <h3>LocalStorage</h3>
                <div id="localstorage-test" class="test-result">Warte auf Test...</div>
            </div>
            
            <div class="test-item">
                <h3>SessionStorage</h3>
                <div id="sessionstorage-test" class="test-result">Warte auf Test...</div>
            </div>
            
            <div class="test-item">
                <h3>Session-Daten Export</h3>
                <div id="sessionexport-test" class="test-result">Warte auf Test...</div>
            </div>
        </div>
        
        <!-- Debug Information -->
        <div class="test-section">
            <h2>üêõ Debug Information</h2>
            <div class="test-item">
                <h3>Vollst√§ndige Session-Daten</h3>
                <div id="debug-session" class="json-display">Lade...</div>
            </div>
            
            <div class="test-item">
                <h3>LocalStorage Inhalt</h3>
                <div id="debug-localstorage" class="json-display">Lade...</div>
            </div>
            
            <div class="test-item">
                <h3>SessionStorage Inhalt</h3>
                <div id="debug-sessionstorage" class="json-display">Lade...</div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Session Management Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/firebase-sync.js"></script>

    <script>
        // Session Test Manager
        class SessionTestManager {
            constructor() {
                this.init();
            }
            
            async init() {
                console.log('üß™ Session Test Manager initialisiert');
                
                // Warte auf alle APIs
                await this.waitForAPIs();
                
                // Initiale Tests ausf√ºhren
                await this.runAllTests();
                
                // Status-Updates alle 5 Sekunden
                setInterval(() => {
                    this.updateStatusOverview();
                }, 5000);
            }
            
            async waitForAPIs() {
                // Warte auf Firebase
                if (window.FirebaseConfig) {
                    await window.FirebaseConfig.waitForReady();
                }
                
                // Warte auf AuthManager
                if (window.AuthAPI) {
                    await window.AuthAPI.waitForInit();
                }
                
                console.log('‚úÖ Alle APIs bereit');
            }
            
            async runAllTests() {
                console.log('üöÄ Starte alle Tests...');
                
                await this.testSessionAPI();
                await this.testAuthAPI();
                await this.testStorage();
                this.updateDebugInfo();
                this.updateStatusOverview();
            }
            
            async testSessionAPI() {
                const result = document.getElementById('sessionapi-test');
                
                try {
                    if (typeof window.SessionAPI !== 'undefined') {
                        result.className = 'test-result success';
                        result.textContent = '‚úÖ SessionAPI verf√ºgbar';
                        
                        // User-Daten Test
                        const userData = window.SessionAPI.getUserData();
                        const userDataResult = document.getElementById('userdata-test');
                        
                        if (userData && (userData.user || userData.username)) {
                            userDataResult.className = 'test-result success';
                            userDataResult.textContent = `‚úÖ User-Daten gefunden: ${userData.username || userData.email || 'Unbekannt'}`;
                        } else {
                            userDataResult.className = 'test-result info';
                            userDataResult.textContent = '‚ÑπÔ∏è Keine User-Daten gefunden (normal wenn nicht eingeloggt)';
                        }
                        
                        // Session-Status Test
                        const sessionStatusResult = document.getElementById('sessionstatus-test');
                        const isActive = window.SessionAPI.isSessionActive();
                        const timeRemaining = window.SessionAPI.getSessionTimeRemaining();
                        
                        if (isActive) {
                            const minutes = Math.floor(timeRemaining / 60000);
                            sessionStatusResult.className = 'test-result success';
                            sessionStatusResult.textContent = `‚úÖ Session aktiv (${minutes} Min. verbleibend)`;
                        } else {
                            sessionStatusResult.className = 'test-result info';
                            sessionStatusResult.textContent = '‚ÑπÔ∏è Session inaktiv';
                        }
                        
                    } else {
                        result.className = 'test-result error';
                        result.textContent = '‚ùå SessionAPI nicht verf√ºgbar';
                    }
                } catch (error) {
                    result.className = 'test-result error';
                    result.textContent = `‚ùå SessionAPI Fehler: ${error.message}`;
                }
            }
            
            async testAuthAPI() {
                const result = document.getElementById('authapi-test');
                
                try {
                    if (typeof window.AuthAPI !== 'undefined') {
                        result.className = 'test-result success';
                        result.textContent = '‚úÖ AuthAPI verf√ºgbar';
                        
                        // Current User Test
                        const currentUser = window.AuthAPI.getCurrentUser();
                        const currentUserResult = document.getElementById('currentuser-test');
                        
                        if (currentUser) {
                            currentUserResult.className = 'test-result success';
                            currentUserResult.textContent = `‚úÖ User eingeloggt: ${currentUser.email}`;
                        } else {
                            currentUserResult.className = 'test-result info';
                            currentUserResult.textContent = '‚ÑπÔ∏è Kein User eingeloggt';
                        }
                        
                        // Auth State Test
                        const authStateResult = document.getElementById('authstate-test');
                        const isLoggedIn = window.AuthAPI.isLoggedIn();
                        
                        if (isLoggedIn) {
                            authStateResult.className = 'test-result success';
                            authStateResult.textContent = '‚úÖ Authentifiziert';
                        } else {
                            authStateResult.className = 'test-result info';
                            authStateResult.textContent = '‚ÑπÔ∏è Nicht authentifiziert';
                        }
                        
                    } else {
                        result.className = 'test-result error';
                        result.textContent = '‚ùå AuthAPI nicht verf√ºgbar';
                    }
                } catch (error) {
                    result.className = 'test-result error';
                    result.textContent = `‚ùå AuthAPI Fehler: ${error.message}`;
                }
            }
            
            async testStorage() {
                // LocalStorage Test
                const localStorageResult = document.getElementById('localstorage-test');
                try {
                    const localStorageKeys = Object.keys(localStorage).filter(key => 
                        key.startsWith('spacenations_') || 
                        key.includes('username') || 
                        key.includes('theme') ||
                        key.includes('alliance')
                    );
                    
                    if (localStorageKeys.length > 0) {
                        localStorageResult.className = 'test-result success';
                        localStorageResult.textContent = `‚úÖ ${localStorageKeys.length} relevante Keys gefunden`;
                    } else {
                        localStorageResult.className = 'test-result info';
                        localStorageResult.textContent = '‚ÑπÔ∏è Keine relevanten LocalStorage-Daten';
                    }
                } catch (error) {
                    localStorageResult.className = 'test-result error';
                    localStorageResult.textContent = `‚ùå LocalStorage Fehler: ${error.message}`;
                }
                
                // SessionStorage Test
                const sessionStorageResult = document.getElementById('sessionstorage-test');
                try {
                    const sessionStorageKeys = Object.keys(sessionStorage).filter(key => 
                        key.startsWith('spacenations_') || 
                        key.includes('username') || 
                        key.includes('user')
                    );
                    
                    if (sessionStorageKeys.length > 0) {
                        sessionStorageResult.className = 'test-result success';
                        sessionStorageResult.textContent = `‚úÖ ${sessionStorageKeys.length} relevante Keys gefunden`;
                    } else {
                        sessionStorageResult.className = 'test-result info';
                        sessionStorageResult.textContent = '‚ÑπÔ∏è Keine relevanten SessionStorage-Daten';
                    }
                } catch (error) {
                    sessionStorageResult.className = 'test-result error';
                    sessionStorageResult.textContent = `‚ùå SessionStorage Fehler: ${error.message}`;
                }
                
                // Session Export Test
                const sessionExportResult = document.getElementById('sessionexport-test');
                try {
                    if (window.SessionAPI) {
                        const exportData = window.SessionAPI.exportSessionData();
                        if (exportData) {
                            sessionExportResult.className = 'test-result success';
                            sessionExportResult.textContent = '‚úÖ Session-Daten erfolgreich exportiert';
                        } else {
                            sessionExportResult.className = 'test-result info';
                            sessionExportResult.textContent = '‚ÑπÔ∏è Keine Session-Daten zum Exportieren';
                        }
                    } else {
                        sessionExportResult.className = 'test-result error';
                        sessionExportResult.textContent = '‚ùå SessionAPI nicht verf√ºgbar';
                    }
                } catch (error) {
                    sessionExportResult.className = 'test-result error';
                    sessionExportResult.textContent = `‚ùå Export Fehler: ${error.message}`;
                }
            }
            
            updateDebugInfo() {
                // Session-Daten
                const debugSession = document.getElementById('debug-session');
                try {
                    if (window.SessionAPI) {
                        const sessionData = {
                            userData: window.SessionAPI.getUserData(),
                            allianceData: window.SessionAPI.getAllianceData(),
                            theme: window.SessionAPI.getTheme(),
                            isSessionActive: window.SessionAPI.isSessionActive(),
                            sessionTimeRemaining: window.SessionAPI.getSessionTimeRemaining()
                        };
                        debugSession.textContent = JSON.stringify(sessionData, null, 2);
                    } else {
                        debugSession.textContent = 'SessionAPI nicht verf√ºgbar';
                    }
                } catch (error) {
                    debugSession.textContent = `Fehler: ${error.message}`;
                }
                
                // LocalStorage
                const debugLocalStorage = document.getElementById('debug-localstorage');
                try {
                    const localStorageData = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.includes('spacenations') || key.includes('username') || key.includes('theme') || key.includes('alliance'))) {
                            localStorageData[key] = localStorage.getItem(key);
                        }
                    }
                    debugLocalStorage.textContent = JSON.stringify(localStorageData, null, 2);
                } catch (error) {
                    debugLocalStorage.textContent = `Fehler: ${error.message}`;
                }
                
                // SessionStorage
                const debugSessionStorage = document.getElementById('debug-sessionstorage');
                try {
                    const sessionStorageData = {};
                    for (let i = 0; i < sessionStorage.length; i++) {
                        const key = sessionStorage.key(i);
                        if (key && (key.includes('spacenations') || key.includes('username') || key.includes('user'))) {
                            sessionStorageData[key] = sessionStorage.getItem(key);
                        }
                    }
                    debugSessionStorage.textContent = JSON.stringify(sessionStorageData, null, 2);
                } catch (error) {
                    debugSessionStorage.textContent = `Fehler: ${error.message}`;
                }
            }
            
            updateStatusOverview() {
                // Session Status
                const sessionStatusCard = document.getElementById('session-status-card');
                const sessionStatus = document.getElementById('session-status');
                const sessionDetails = document.getElementById('session-details');
                
                if (window.SessionAPI && window.SessionAPI.isSessionActive()) {
                    const timeRemaining = window.SessionAPI.getSessionTimeRemaining();
                    const minutes = Math.floor(timeRemaining / 60000);
                    
                    sessionStatusCard.className = 'status-card active';
                    sessionStatus.className = 'status-value success';
                    sessionStatus.textContent = '‚úÖ';
                    sessionDetails.textContent = `Aktiv (${minutes}m verbleibend)`;
                } else {
                    sessionStatusCard.className = 'status-card';
                    sessionStatus.className = 'status-value';
                    sessionStatus.textContent = '‚ùå';
                    sessionDetails.textContent = 'Inaktiv';
                }
                
                // Auth Status
                const authStatusCard = document.getElementById('auth-status-card');
                const authStatus = document.getElementById('auth-status');
                const authDetails = document.getElementById('auth-details');
                
                if (window.AuthAPI && window.AuthAPI.isLoggedIn()) {
                    const user = window.AuthAPI.getCurrentUser();
                    authStatusCard.className = 'status-card active';
                    authStatus.className = 'status-value success';
                    authStatus.textContent = '‚úÖ';
                    authDetails.textContent = user ? user.email : 'Eingeloggt';
                } else {
                    authStatusCard.className = 'status-card';
                    authStatus.className = 'status-value';
                    authStatus.textContent = '‚ùå';
                    authDetails.textContent = 'Nicht eingeloggt';
                }
                
                // Storage Status
                const storageStatusCard = document.getElementById('storage-status-card');
                const storageStatus = document.getElementById('storage-status');
                const storageDetails = document.getElementById('storage-details');
                
                try {
                    const totalKeys = localStorage.length + sessionStorage.length;
                    if (totalKeys > 0) {
                        storageStatusCard.className = 'status-card active';
                        storageStatus.className = 'status-value success';
                        storageStatus.textContent = '‚úÖ';
                        storageDetails.textContent = `${totalKeys} Keys gespeichert`;
                    } else {
                        storageStatusCard.className = 'status-card';
                        storageStatus.className = 'status-value';
                        storageStatus.textContent = '‚ùå';
                        storageDetails.textContent = 'Keine Daten';
                    }
                } catch (error) {
                    storageStatusCard.className = 'status-card error';
                    storageStatus.className = 'status-value error';
                    storageStatus.textContent = '‚ùå';
                    storageDetails.textContent = 'Fehler';
                }
            }
        }
        
        // Globale Funktionen
        async function runAllTests() {
            if (window.sessionTestManager) {
                await window.sessionTestManager.runAllTests();
            }
        }
        
        async function testSessionAPI() {
            if (window.sessionTestManager) {
                await window.sessionTestManager.testSessionAPI();
            }
        }
        
        async function testAuthAPI() {
            if (window.sessionTestManager) {
                await window.sessionTestManager.testAuthAPI();
            }
        }
        
        async function testStorage() {
            if (window.sessionTestManager) {
                await window.sessionTestManager.testStorage();
            }
        }
        
        function clearAllData() {
            if (confirm('Alle Session-Daten l√∂schen? Dies wird Sie abmelden!')) {
                if (window.SessionAPI) {
                    window.SessionAPI.clearAllSessionData();
                }
                localStorage.clear();
                sessionStorage.clear();
                alert('Alle Daten gel√∂scht!');
                location.reload();
            }
        }
        
        function exportSessionData() {
            if (window.SessionAPI) {
                const exportData = window.SessionAPI.exportSessionData();
                if (exportData) {
                    const blob = new Blob([exportData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `spacenations-session-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('Session-Daten exportiert!');
                } else {
                    alert('Keine Session-Daten zum Exportieren gefunden.');
                }
            } else {
                alert('SessionAPI nicht verf√ºgbar.');
            }
        }
        
        // Test Manager starten
        document.addEventListener('DOMContentLoaded', () => {
            window.sessionTestManager = new SessionTestManager();
        });
    </script>
</body>
</html>